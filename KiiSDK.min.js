!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var s=e();for(var i in s)("object"==typeof exports?exports:t)[i]=s[i]}}(self,(function(){return(()=>{"use strict";var t={d:(e,s)=>{for(var i in s)t.o(s,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:s[i]})}};t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),t.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),t.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var e={};t.r(e),t.d(e,{ArithmeticException:()=>h,IllegalStateException:()=>c,InvalidDisplayNameException:()=>r,InvalidEmailException:()=>a,InvalidPasswordException:()=>s,InvalidPhoneNumberException:()=>o,InvalidURIException:()=>d,InvalidUserIdentifierException:()=>i,InvalidUsernameException:()=>n,Kii:()=>Ut,KiiACL:()=>ot,KiiACLAction:()=>rt,KiiACLEntry:()=>at,KiiAnonymousUser:()=>xt,KiiAnyAuthenticatedUser:()=>Wt,KiiAppAdminContext:()=>_t,KiiApplication:()=>At,KiiBucket:()=>ft,KiiClause:()=>lt,KiiEncryptedBucket:()=>wt,KiiErrorParser:()=>Gt,KiiGeoPoint:()=>$t,KiiGroup:()=>x,KiiObject:()=>dt,KiiPushInstallation:()=>H,KiiPushMessageBuilder:()=>q,KiiPushSubscription:()=>F,KiiQuery:()=>pt,KiiRequestError:()=>w,KiiServerCodeEntry:()=>Nt,KiiServerCodeExecResult:()=>Ot,KiiSite:()=>St,KiiThing:()=>V,KiiThingContext:()=>Pt,KiiThingQuery:()=>K,KiiThingQueryResult:()=>M,KiiTopic:()=>L,KiiUser:()=>Q,KiiUserBuilder:()=>Ct});class s extends Error{constructor(t,e){super(t),this.target=e}}class i extends Error{constructor(t,e){super(t),this.target=e}}class n extends Error{constructor(t="Unable to set username. Must be between 3 and 64 characters, which can include alphanumeric characters as well as underscores '_' and periods '.'",e){super(t),this.target=e}}class r extends Error{constructor(t="Unable to set displayName. Must be between 1-50 characters.",e){super(t),this.target=e}}class o extends Error{constructor(t,e){super(t),this.target=e}}class a extends Error{constructor(t,e){super(t),this.target=e}}class h extends Error{constructor(t,e){super(`ArithmeticException: ${t}`),this.target=e}}class u extends Error{constructor(t,e){super(`InvalidArgument: ${t}`),this.msg=t,this.target=e}}class c extends Error{constructor(t,e){super(`IllegalState: ${t}`),this.msg=t,this.target=e}}class d extends Error{constructor(t="Unable to set URI. Must be of the form kiicloud://some/path/to/object/or/entity",e){super(t),this.target=e}}class p extends Error{constructor(t="Unable to set country code. Must be 2 alphabetic characters. Ex: US, JP, CN",e){super(t),this.target=e}}class l extends Error{constructor(t="Unable to set URI. Must be of the form kiicloud://some/path/to/object/or/entity",e){super(`UnsupportedOperationException: ${t}`),this.target=e}}const g=(t,e,s,i)=>{let n="";if("string"==typeof e.body)return e.body?(n+=`: ${e.body}`,f(e.status,"",n,s,i)):f(e.status,"",n,s,i);if("object"==typeof e.body){const t=e.body.errorCode;null!=t&&(n+=`${t}`);const r=e.body.message;return null!=r&&(n+=`: ${r}`),f(e.status,null!=t?t:"",n,s,i)}return f(e.status,"",n,s,i)},f=(t,e,s,i,n)=>{const r=new w(t,e,s,i);return n?(Object.assign(r,n),r):r};class w extends Error{constructor(t,e,s,i){super(s),this.status=t,this.code=e,this.target=i}}const y=t=>200<=t&&t<300,m=864e13,v=t=>(t=I(t),/^[^@]+@[^@]+$/.test(t)),I=t=>t.replace(/^(\s|\u00A0)+|(\s|\u00A0)+$/g,""),b=(t,e)=>"string"==typeof e&&!!(e=I(e)).match(t),T=t=>b(/^[\\+]?[0-9]{10,}$/i,t),A=t=>b(/^[\\+]{1}[0-9]{2}/,t),D=t=>(t=I(t),b(/^\d+$/,t)),N=t=>b(/^[a-z]{2}$/i,t),O=t=>b(/^[\x20-\x7E]{4,50}$/,t),E=t=>b(/^[a-zA-Z0-9-_\\.]{3,64}$/i,t),_=(t,e)=>{if(isNaN(t)||isNaN(e))throw new Error("Parameters should be a number");if(Math.abs(t+e)>m)throw new h("Addition of "+t+" and "+e+" result in long overflow",void 0);return t+e},P=(t,e)=>{if(isNaN(t)||isNaN(e))throw new Error("Parameters should be a number");if(Math.abs(t*e)>m)throw new h("Multiplication of "+t+" and "+e+" result in long overflow",void 0);return t*e},R=(t,e)=>{let s=0;try{const i=P(t,1e3);s=_(e,i)}catch(t){if(!(t instanceof h))throw t;s=m}return s},S=(t,e)=>{let s=0;try{const i=P(t,1e3);s=_(e,i)}catch(t){if(!(t instanceof h))throw t;s=m}return new Date(s)},U=t=>"string"==typeof t&&t.length>0,k=(t,e)=>{const s=Error(t);return s.name=e,s};function C(t){if(null===t||"object"!=typeof t)return!1;const e=Object.keys(t);return!(e.length>2||(2!==e.length||!e.includes("success")||!e.includes("failure"))&&(1!==e.length||!e.includes("success")&&!e.includes("failure")))}var $=function(t,e,s,i){return new(s||(s=Promise))((function(n,r){function o(t){try{h(i.next(t))}catch(t){r(t)}}function a(t){try{h(i.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}h((i=i.apply(t,e||[])).next())}))};class x{constructor(t){this.app=t,this.id="",this.name="",this.owner=void 0,this.addMembers={},this.removeMembers={}}static groupWithJSON(t,e=At.globalApp){const s=new x(e);if(null!=t.groupID&&s.setId(t.groupID),null!=t.name&&s.setName(t.name),null!=t.owner){const e=Q.userWithID(t.owner);s.setOwner(e)}return s}getID(){return this.id}setId(t){this.id=t}getUUID(){return this.id}getName(){return this.name}setName(t){this.name=t}getCachedOwner(){return this.owner}objectURI(){return 0==this.id.length?null:`kiicloud://groups/${this.getID()}`}static registerGroupWithID(t,e,s,i=At.globalApp){return $(this,void 0,void 0,(function*(){const n=i.getCurrentUser();if(null===n)throw k("owner is null",this);if(null===t||0==t.length)throw k("groupID is null or empty",this);if(!b(/^[a-z0-9-_.]{1,30}$/,t))throw k(`invalid groupID : ${t}`,this);if(0==e.length)throw k("groupName is null or empty",this);return x.registerGroupWithIDAndOwner(t,e,n.getID(),s,i)}))}static registerGroupWithIDAndOwner(t,e,s,i,n=At.globalApp){return $(this,void 0,void 0,(function*(){if(null===t||0==t.length)throw k("groupID is null or empty",this);if(!W(t))throw k(`invalid groupID : ${t}`,this);if(null===e||0==e.length)throw k("groupName is null or empty",this);if(!s)throw k("owner is null",this);const r=`/apps/${n.getAppID()}/groups/${t}`;let o;o={name:e,owner:s},(null==i?void 0:i.length)>0&&(o.members=i.map((t=>t.getID())));const a=n.newRequest("PUT",r);a.setContentType("application/vnd.kii.GroupCreationRequest+json");const h=yield a.send(JSON.stringify(o));if(y(h.status)){const s=new x(n);return s.setId(t),s.setName(e),(null==i?void 0:i.length)>0&&i.forEach((t=>{const e=t.getID();null!=e&&(s.addMembers[e]=t)})),s}throw g(0,h,void 0,null)}))}bucketWithName(t){return new ft(t,this,this.app)}encryptedBucketWithName(t){return new wt(t,this,this.app)}addUser(t){const e=t.getID();null!=e&&0!=e.length&&(this.addMembers[e]=t,delete this.removeMembers[e])}removeUser(t){const e=t.getID();if(null==e||0==e.length)throw k("User ID is null",this);return delete this.addMembers[e],this.removeMembers[e]=t,this}getMemberList(){return $(this,void 0,void 0,(function*(){const t=`/apps/${this.app.getAppID()}/groups/${this.getID()}/members`,e=this.app.newRequest("GET",t);e.addHeader("Accept","application/vnd.kii.MembersRetrievalResponse+json");const s=yield e.send();if(y(s.status))return s.body.members.map((t=>Q.userWithID(t.userID,this.app)));throw g(0,s,this,null)}))}changeGroupName(t){return $(this,void 0,void 0,(function*(){const e=this.getID();if(0==e.length)throw k("Invalid group. Save the group on the server before updating the name.",this);if(0==t.trim().length)throw k("Invalid group name.",this);const s=`/apps/${this.app.getAppID()}/groups/${e}/name`,i=this.app.newRequest("PUT",s);i.setContentType("text/plain");const n=yield i.send(t);if(y(n.status))return this.setName(t),this;throw g(0,n,this,null)}))}save(){var t;return $(this,void 0,void 0,(function*(){if(0==this.getID().length&&this.app&&this.app.getCurrentUser){const e=null===(t=this.app.getCurrentUser())||void 0===t?void 0:t.getID();yield this.createGroup(e)}return yield this.saveMembers(),this}))}saveWithOwner(t){return $(this,void 0,void 0,(function*(){if(0==this.getID().length){if(0==t.length)throw k("Owner ID must not be empty.",this);yield this.createGroup(t)}return yield this.saveMembers(),this}))}createGroup(t){return $(this,void 0,void 0,(function*(){const e=`/apps/${this.app.getAppID()}/groups`;let s={name:this.getName()};t&&(s.owner=t);const i=this.app.newRequest("POST",e);i.setContentType("application/vnd.kii.GroupCreationRequest+json");const n=yield i.send(JSON.stringify(s));if(!y(n.status))throw g(0,n,this,null);{const e=n.body.groupID;this.setId(e),t&&this.setOwner(Q.userWithID(t))}}))}saveMembers(){return $(this,void 0,void 0,(function*(){for(const t of Object.keys(this.addMembers))yield this.addMember(t);for(const t of Object.keys(this.removeMembers))yield this.removeMember(t)}))}addMember(t){return $(this,void 0,void 0,(function*(){const e=`/apps/${this.app.getAppID()}/groups/${this.getID()}/members/${t}`,s=this.app.newRequest("PUT",e),i=yield s.send();if(!y(i.status))throw g(0,i,this,{addMembersArray:Object.values(this.addMembers),removeMembersArray:Object.values(this.removeMembers)});delete this.addMembers[t]}))}removeMember(t){return $(this,void 0,void 0,(function*(){const e=`/apps/${this.app.getAppID()}/groups/${this.getID()}/members/${t}`,s=this.app.newRequest("DELETE",e),i=yield s.send();if(!y(i.status))throw g(0,i,this,{addMembersArray:Object.values(this.addMembers),removeMembersArray:Object.values(this.removeMembers)});delete this.removeMembers[t]}))}refresh(){return $(this,void 0,void 0,(function*(){const t=this.getID();if(0==t.length)throw k("This group does not have ID.",this);const e=`/apps/${this.app.getAppID()}/groups/${t}`,s=this.app.newRequest("GET",e);s.addHeader("Accept","application/vnd.kii.GroupRetrievalResponse+json");const i=yield s.send();if(y(i.status))return this.updateWithJSON(i.body),this;throw g(0,i,this,null)}))}delete(){return $(this,void 0,void 0,(function*(){const t=this.getID();if(0==t.length)throw k("This group does not have ID.",this);const e=`/apps/${this.app.getAppID()}/groups/${t}`,s=this.app.newRequest("DELETE",e),i=yield s.send();if(y(i.status))return this;throw g(0,i,this,null)}))}getOwner(){return $(this,void 0,void 0,(function*(){return yield this.refresh(),this.getCachedOwner()}))}setOwner(t){this.owner=t}getACLEntityString(){return`GroupID:${this.getID()}`}getPath(){return`/groups/${this.id}`}static groupWithName(t,e=At.globalApp){const s=new x(e);return s.setName(t),s}static groupWithNameAndMembers(t,e,s=At.globalApp){const i=new x(s);return i.setName(t),e.forEach((t=>{const e=t.getID();null!=e&&(i.addMembers[e]=t)})),i}static groupWithID(t,e=At.globalApp){const s=new x(e);return s.setId(t),s}static groupWithURI(t,e=At.globalApp){const s=t.substr("kiicloud://".length).split("/"),i=s.length;if(!s.length)throw new d(void 0,void 0);const n=new x(e);return n.setId(s[i-1]),n}topicWithName(t){const e=`/groups/${this.getID()}`;return new L(e,t,this.app)}listTopics(t){return $(this,void 0,void 0,(function*(){let e=`/apps/${this.app.getAppID()}/groups/${this.getID()}/topics`;t&&t.length>0&&(e+=`?paginationKey=${encodeURIComponent(t)}`);const s=this.app.newRequest("GET",e),i=yield s.send();if(y(i.status)){const t=i.body.paginationKey||null;return[i.body.topics.map((t=>this.topicWithName(t.topicID))),t]}throw g(0,i,this,null)}))}updateWithJSON(t){var e;const s=t.groupID;void 0!==s&&this.setId(s);const i=null!==(e=t.name)&&void 0!==e?e:"";this.setName(i);const n=t.owner;void 0!==n?this.setOwner(Q.userWithID(n)):this.setOwner(null)}}const W=t=>"string"==typeof t&&null!=t.match(/^[a-z0-9-_.]{1,30}$/);var j=function(t,e,s,i){return new(s||(s=Promise))((function(n,r){function o(t){try{h(i.next(t))}catch(t){r(t)}}function a(t){try{h(i.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}h((i=i.apply(t,e||[])).next())}))};class L{constructor(t,e,s){this.parentUri=t,this.topicName=e,this.app=s}getName(){return this.topicName}getPath(){return`${this.parentUri}/topics/${this.topicName}`}exists(){return j(this,void 0,void 0,(function*(){const t=`/apps/${this.app.getAppID()}${this.parentUri}/topics/${this.topicName}`,e=this.app.newRequest("HEAD",t),s=yield e.send();if(y(s.status))return!0;if(404==s.status)return!1;{const t=g(0,s,this,null);throw t.message=`check topic failed. statusCode: ${s.status}`,t}}))}save(){return j(this,void 0,void 0,(function*(){const t=`/apps/${this.app.getAppID()}${this.parentUri}/topics/${this.topicName}`,e=this.app.newRequest("PUT",t),s=yield e.send();if(y(s.status))return this;throw g(0,s,this,null)}))}sendMessage(t){return j(this,void 0,void 0,(function*(){const e=`/apps/${this.app.getAppID()}${this.parentUri}/topics/${this.topicName}/push/messages`,s=this.app.newRequest("POST",e);s.setContentType("application/vnd.kii.SendPushMessageRequest+json");const i=yield s.send(JSON.stringify(t));if(y(i.status))return[this,t];throw g(0,i,this,null)}))}deleteTopic(){return j(this,void 0,void 0,(function*(){const t=`/apps/${this.app.getAppID()}${this.parentUri}/topics/${this.topicName}`,e=this.app.newRequest("DELETE",t),s=yield e.send();if(y(s.status))return this;throw g(0,s,this,null)}))}acl(){return ot.aclWithParent(this,this.app)}}class q{constructor(t){this.gcm={enabled:!0},this.apns={enabled:!0},this.jpush={enabled:!0},this.mqtt={enabled:!0},this.sendToDevelopment=!1,this.sendToProduction=!1,this.data=t}build(){const t={data:this.data,gcm:this.gcm,apns:this.apns,jpush:this.jpush,mqtt:this.mqtt};return this.sendToDevelopment&&(t.sendToDevelopment=this.sendToDevelopment),this.sendToProduction&&(t.sendToProduction=this.sendToProduction),t}setSendToDevelopment(t){return this.sendToDevelopment=t,this}setSendToProduction(t){return this.sendToProduction=t,this}enableGcm(t){return this.gcm.enabled=t,this}enableApns(t){return this.apns.enabled=t,this}enableJpush(t){return this.jpush.enabled=t,this}enableMqtt(t){return this.mqtt.enabled=t,this}gcmData(t){return this.gcm.data=t,this}gcmCollapseKey(t){return this.gcm.collapseKey=t,this}gcmDelayWhileIdle(t){return this.gcm.delayWhileIdle=t,this}gcmTimeToLive(t){return this.gcm.timeToLive=t,this}gcmRestrictedPackageName(t){return this.gcm.restrictedPackageName=t,this}apnsData(t){return this.apns.data=t,this}apnsAlert(t){return this.apns.alert=t,this}apnsSound(t){return this.apns.sound=t,this}apnsBadge(t){return this.apns.badge=t,this}apnsContentAvailable(t){return t>0?this.apns.contentAvailable=!0:delete this.apns.contentAvailable,this}apnsCategory(t){return this.apns.category=t,this}apnsMutableContent(t){return t>0?this.apns.mutableContent=!0:delete this.apns.mutableContent,this}jpushData(t){return this.jpush.data=t,this}mqttData(t){return this.mqtt.data=t,this}}class K{constructor(t,e=null){if(this.owner=null,this.groups=null,this.limit=0,this.thingType=void 0,this.paginationKey="",!(t||e&&0!=e.length))throw new u("Both the owner and groups parameter are optional, but at least one of them must be supplied.",void 0);this.owner=t,this.groups=e,this.limit=0}static thingQuery(t,e=null){return new K(t,e)}setLimit(t){this.limit=t>0?t:0}getLimit(){return this.limit}setThingType(t){this.thingType=t}getThingType(){return this.thingType}setPaginationKey(t){this.paginationKey=t}getPaginationKey(){return this.paginationKey}clone(){const t=new K(K.clone(this.owner),K.clone(this.groups));return t.limit=this.limit,t.thingType=this.thingType,t.paginationKey=this.paginationKey,t}static clone(t){if(!t||"object"!=typeof t||t instanceof At)return t;const e=new t.constructor;for(const s in t)e[s]=this.clone(t[s]);return e}dictValue(){const t={};this.limit&&this.limit>0&&(t.bestEffortLimit=this.limit),this.paginationKey&&(t.paginationKey=this.paginationKey);const e=[];if(this.owner){const t={type:"contains",field:"userOwners",value:this.owner.getID()};e.push(t)}if(this.groups&&this.groups.length>0)for(const t of this.groups){const s={type:"contains",field:"groupOwners",value:t.getID()};e.push(s)}let s,i;if(0==e.length)throw new u("Query clause must include the 'contains' clause.",this);return s=1==e.length?e[0]:{type:"or",clauses:e},i=null!==this.thingType&&void 0!==this.thingType?{clause:{type:"and",clauses:[{type:"eq",field:"_thingType",value:this.thingType},s]}}:{clause:s},t.thingQuery=i,t}}class M{constructor(t,e,s){this.query=t,this.results=e,this.paginationKey=s}getResult(){return this.results}hasNext(){return!!this.paginationKey}getNextKiiThingQuery(){if(!this.hasNext())return null;const t=this.query.clone();return t.setPaginationKey(this.paginationKey),t}getNextResult(){return t=this,e=void 0,i=function*(){if(!this.hasNext())throw k("No more pages to fetch",this);const t=this.getNextKiiThingQuery();if(!t)throw k("No more pages to fetch",this);return V.executeQuery(t)},new((s=void 0)||(s=Promise))((function(n,r){function o(t){try{h(i.next(t))}catch(t){r(t)}}function a(t){try{h(i.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}h((i=i.apply(t,e||[])).next())}));var t,e,s,i}}var B=function(t,e,s,i){return new(s||(s=Promise))((function(n,r){function o(t){try{h(i.next(t))}catch(t){r(t)}}function a(t){try{h(i.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}h((i=i.apply(t,e||[])).next())}))};class V{constructor(t=null,e=At.globalApp){this.fields=t,this.app=e,this.online=null,this.onlineStatusModifiedAt=null,this.thingID=null,this.vendorThingID=void 0,this.accessToken="",this.created=null,this.disabled=void 0,this.fields&&this.renewThingFields(this.fields)}renewThingFields(t){this.online=null,this.onlineStatusModifiedAt=null,this.fields=t,this.thingID=t._thingID||null,this.vendorThingID=t._vendorThingID||void 0,this.accessToken=t._accessToken||"",this.created=t._created?new Date(t._created):null,this.disabled=t._disabled,void 0!==t._online&&(this.online=t._online),t._onlineStatusModifiedAt&&(this.onlineStatusModifiedAt=new Date(t._onlineStatusModifiedAt)),delete this.fields._thingID,delete this.fields._vendorThingID,delete this.fields._accessToken,delete this.fields._created,delete this.fields._disabled}getThingID(){return this.thingID}setThingID(t){this.thingID=t}getVendorThingID(){return this.vendorThingID}setVendorThingID(t){this.vendorThingID=t}getAccessToken(){return this.accessToken||""}setAccessToken(t){this.accessToken=t}getCreated(){return this.created}getDisabled(){return void 0!==this.disabled&&this.disabled}isOnline(){return this.online}getOnlineStatusModifiedAt(){return this.onlineStatusModifiedAt}getPath(){return`/things/${this.thingID}`}static register(t,e=At.globalApp){return B(this,void 0,void 0,(function*(){const s=`/apps/${e.getAppID()}/things`,i=e.newRequest("POST",s);i.setContentType("application/vnd.kii.ThingRegistrationAndAuthorizationRequest+json"),i.isSendAccessToken(!1);const n=yield i.send(JSON.stringify(t));if(!y(n.status))throw g(0,n,void 0,null);return new V(n.body,e)}))}static executeQuery(t,e=At.globalApp){return B(this,void 0,void 0,(function*(){if(!t)throw k("thingQuery is null",this);const s=`/apps/${e.getAppID()}/things/query`,i=e.newRequest("POST",s);i.setContentType("application/vnd.kii.ThingQueryRequest+json");const n=yield i.send(JSON.stringify(t.dictValue()));if(!y(n.status))throw g(0,n,void 0,null);const r=n.body,o=[];for(const t of r.results)o.push(new V(t,e));return new M(t,o,r.nextPaginationKey)}))}refresh(){return B(this,void 0,void 0,(function*(){const t=yield this.refreshRequest();return this.renewThingFields(t),this}))}refreshRequest(){return B(this,void 0,void 0,(function*(){let t="";t=this.thingID?this.thingID:`VENDOR_THING_ID:${this.vendorThingID}`;const e=`/apps/${this.app.getAppID()}/things/${t}`,s=this.app.newRequest("GET",e),i=yield s.send();if(!y(i.status))throw g(0,i,this,null);return i.body}))}update(){return B(this,void 0,void 0,(function*(){const t=yield this.refreshRequest();this.fields?(Object.assign(t,this.fields),this.fields=t):this.fields=t;const e=`/apps/${this.app.getAppID()}/things/${this.thingID}`,s=this.app.newRequest("PATCH",e);s.setContentType("application/vnd.kii.ThingUpdateRequest+json");const i=yield s.send(JSON.stringify(this.fields));if(!y(i.status))throw g(0,i,this,null);return this}))}deleteThing(){return B(this,void 0,void 0,(function*(){const t=`/apps/${this.app.getAppID()}/things/${this.thingID}`,e=this.app.newRequest("DELETE",t);e.setContentType("application/vnd.kii.ThingUpdateRequest+json");const s=yield e.send();if(!y(s.status))throw g(0,s,this,null);return this}))}isOwner(t){return B(this,void 0,void 0,(function*(){const e=this.getOwnerURL(this.thingID,t),s=this.app.newRequest("HEAD",e),i=yield s.send(JSON.stringify(this.fields));if(404===i.status)return[this,t,!1];if(!y(i.status))throw g(0,i,this,null);return[this,t,!0]}))}registerOwner(t){return B(this,void 0,void 0,(function*(){const e=this.getOwnerURL(this.thingID,t),s=this.app.newRequest("PUT",e),i=yield s.send(JSON.stringify(this.fields));if(!y(i.status))throw g(0,i,this,null);return[this,t]}))}registerOwnerWithPassword(t,e){return B(this,void 0,void 0,(function*(){return V.registerOwnerWithIdentifierAndPassword(this.thingID,t,e,this.app).then((()=>[this,t]))}))}static registerOwnerWithThingID(t,e,s=At.globalApp){return B(this,void 0,void 0,(function*(){return V.registerOwnerWithIdentifier(t,e,s)}))}static registerOwnerWithThingIDAndPassword(t,e,s,i=At.globalApp){return B(this,void 0,void 0,(function*(){return V.registerOwnerWithIdentifierAndPassword(t,e,s,i)}))}static registerOwnerWithVendorThingID(t,e,s=At.globalApp){return B(this,void 0,void 0,(function*(){return U(t)?V.registerOwnerWithIdentifier("VENDOR_THING_ID:"+t,e,s):V.registerOwnerWithIdentifier(null,e,s)}))}static registerOwnerWithVendorThingIDAndPassword(t,e,s,i=At.globalApp){return B(this,void 0,void 0,(function*(){if(!U(t))throw k("identifier is null or empty",void 0);return V.registerOwnerWithIdentifierAndPassword("VENDOR_THING_ID:"+t,e,s,i)}))}static registerOwnerWithIdentifier(t,e,s=At.globalApp){return B(this,void 0,void 0,(function*(){if(!t)throw k("identifier is null or empty",void 0);if(!e)throw k("owner is null",void 0);const i=V.prototype.getOwnerURL(t,e,s),n=s.newRequest("PUT",i),r=yield n.send();if(!y(r.status))throw g(0,r,void 0,null);return e}))}static registerOwnerWithIdentifierAndPassword(t,e,s,i=At.globalApp){return B(this,void 0,void 0,(function*(){if(!t)throw k("identifier is null or empty",void 0);if(!s)throw k("password is null or empty",void 0);if(!e)throw k("owner is null",void 0);const n=`/apps/${i.getAppID()}/things/${t}/ownership`,r=i.newRequest("POST",n);r.setContentType("application/vnd.kii.ThingOwnershipRequest+json");const o={thingPassword:s};e instanceof Q?o.userID=e.getID():e instanceof x&&(o.groupID=e.getID());const a=yield r.send(JSON.stringify(o));if(!y(a.status))throw g(0,a,void 0,null);return e}))}getOwnerURL(t,e,s=null){let i=null,n=null;const r=s||this.app;if(e instanceof Q)n=e.getID(),i="user";else{if(!(e instanceof x))throw k("owner should be instance of user or group",this);n=e.getID(),i="group"}if(!n)throw k("owner instance does not have id",this);return`/apps/${r.getAppID()}/things/${t}/ownership/${i}:${n}`}unregisterOwner(t){return B(this,void 0,void 0,(function*(){const e=this.getOwnerURL(this.thingID,t),s=this.app.newRequest("DELETE",e),i=yield s.send();if(!y(i.status))throw g(0,i,this,null);return[this,t]}))}disable(){return B(this,void 0,void 0,(function*(){return this.changeStatus(!0)}))}enable(){return B(this,void 0,void 0,(function*(){return this.changeStatus(!1)}))}changeStatus(t){return B(this,void 0,void 0,(function*(){const e=`/apps/${this.app.getAppID()}/things/${this.thingID}/status`,s=this.app.newRequest("PUT",e);s.setContentType("application/vnd.kii.ThingStatusUpdateRequest+json");const i=yield s.send(JSON.stringify({disabled:t}));if(!y(i.status))throw g(0,i,this,null);return this.disabled=t,this}))}updatePassword(t){return B(this,void 0,void 0,(function*(){if(!this.app.isAdmin())throw k("updatePassword can be used only by app admin.",this);if(!t)throw new u("newPassword is null or empty",this);const e=JSON.stringify({newPassword:t});let s="";s=this.thingID?this.thingID:`VENDOR_THING_ID:${this.vendorThingID}`;const i=`/apps/${this.app.getAppID()}/things/${s}/password`,n=this.app.newRequest("PUT",i);n.setContentType("application/vnd.kii.ChangeThingPasswordRequest+json");const r=yield n.send(e);if(!y(r.status))throw g(0,r,this,null);return this}))}static loadWithVendorThingID(t,e=At.globalApp){return B(this,void 0,void 0,(function*(){const s=`VENDOR_THING_ID:${t}`;return V.load(s,e)}))}static loadWithThingID(t,e=At.globalApp){return B(this,void 0,void 0,(function*(){return V.load(t,e)}))}static load(t,e=At.globalApp){return B(this,void 0,void 0,(function*(){const s=`/apps/${e.getAppID()}/things/${t}`,i=e.newRequest("GET",s),n=yield i.send();if(!y(n.status))throw g(0,n,void 0,null);const r=n.body;return new V(r,e)}))}bucketWithName(t){return new ft(t,this,this.app)}encryptedBucketWithName(t){return new wt(t,this,this.app)}topicWithName(t){if("string"!=typeof t||""===t)throw k("topicName should not null or empty",this);return new L(this.getPath(),t,this.app)}listTopics(t=""){return B(this,void 0,void 0,(function*(){let e=`/apps/${this.app.getAppID()}/things/${this.getThingID()}/topics`;t&&t.length>0&&(e+=`?paginationKey=${encodeURIComponent(t)}`);const s=this.app.newRequest("GET",e),i=yield s.send();if(!y(i.status))throw g(0,i,this,null);const n=i.body.paginationKey;return[i.body.topics.map((t=>this.topicWithName(t.topicID))),n||null]}))}pushSubscription(){return new F(this,this.app)}getHttpURI(){return`${Ut.getBaseURL()}/apps/${this.app.getAppID()}/things/${this.getThingID()}`}static thingWithID(t,e=At.globalApp){if(!t)throw new u("thingID should not null or empty",void 0);const s=new V(null,e);return s.setThingID(t),s}getSubscriberPath(){return`things/${this.getThingID()}`}}var G=function(t,e,s,i){return new(s||(s=Promise))((function(n,r){function o(t){try{h(i.next(t))}catch(t){r(t)}}function a(t){try{h(i.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}h((i=i.apply(t,e||[])).next())}))};class F{constructor(t,e){this.subscriber=t,this.app=e}getSubscriber(){return this.subscriber}subscribe(t){return G(this,void 0,void 0,(function*(){const e=this.getRequestHTTPURI(t),s=this.app.newRequest("PUT",e),i=yield s.send();if(y(i.status))return[this,t];throw g(0,i,this,null)}))}unsubscribe(t){return G(this,void 0,void 0,(function*(){const e=this.getRequestHTTPURI(t),s=this.app.newRequest("DELETE",e),i=yield s.send();if(y(i.status))return[this,t];throw g(0,i,t,null)}))}isSubscribed(t){return G(this,void 0,void 0,(function*(){const e=this.getRequestHTTPURI(t),s=this.app.newRequest("GET",e),i=yield s.send();if(y(i.status))return[this,t,!0];if(["FILTER_NOT_FOUND","PUSH_SUBSCRIPTION_NOT_FOUND"].includes(i.body.errorCode))return[this,t,!1];throw g(0,i,this,null)}))}getRequestHTTPURI(t){let e="";return this.subscriber instanceof Q&&(e=`users/${this.subscriber.getID()}`),this.subscriber instanceof V&&(e=`things/${this.subscriber.getThingID()}`),t instanceof ft?`/apps/${this.app.getAppID()}${t.getPath()}/filters/all/push/subscriptions/${e}`:t instanceof L?`/apps/${this.app.getAppID()}${t.getPath()}/push/subscriptions/${e}`:""}}class H{constructor(t,e){this.user=t,this.app=e}installGcm(t,e){return G(this,void 0,void 0,(function*(){if(!U(t))throw k("installationRegistrationID must not be null or empty.",this);return this.install(t,"ANDROID",e)}))}installApns(t,e){return G(this,void 0,void 0,(function*(){if(!U(t))throw k("deviceToken must not be null or empty.",this);return this.install(t,"IOS",e)}))}installMqtt(t){return G(this,void 0,void 0,(function*(){return this.install("","MQTT",t)}))}getMqttEndpoint(t){return G(this,void 0,void 0,(function*(){if(!U(t))throw k("installationID must not be null or empty.",this);const e=`/apps/${this.app.getAppID()}/installations/${t}/mqtt-endpoint`,s=this.app.newRequest("GET",e),i=t=>s.send().then((e=>{if(y(e.status))return e.body;if(503===e.status&&--t>0)return new Promise(((e,s)=>{setTimeout((()=>e(i(t))),1e3)}));throw g(0,e,this,null)}));return i(3)}))}uninstall(t,e){return G(this,void 0,void 0,(function*(){if(!U(t))throw k("installationRegistrationID must not be null or empty.",this);if(!this.validateDeviceType(e))throw k(`Unsupported deviceType ${e}`,this);const s=`/apps/${this.app.getAppID()}/installations/${e}:${t}`,i=this.app.newRequest("DELETE",s),n=yield i.send();if(!y(n.status))throw g(0,n,this,null)}))}validateDeviceType(t){return"ANDROID"===t||"MQTT"===t||"IOS"===t}uninstallByInstallationID(t){return G(this,void 0,void 0,(function*(){if(!U(t))throw k("installationID must not be null or empty.",this);const e=`/apps/${this.app.getAppID()}/installations/${t}`,s=this.app.newRequest("DELETE",e),i=yield s.send();if(!y(i.status))throw g(0,i,this,null)}))}install(t,e,s){return G(this,void 0,void 0,(function*(){if("boolean"!=typeof s)throw k("type of development must be boolean.",this);const i=`/apps/${this.app.getAppID()}/installations`,n=this.app.newRequest("POST",i);n.setContentType("application/vnd.kii.InstallationCreationRequest+json");const r={development:s,deviceType:e};t&&(r.installationRegistrationID=t);const o=yield n.send(JSON.stringify(r));if(y(o.status))return o.body;throw g(0,o,this,null)}))}}var J=function(t,e,s,i){return new(s||(s=Promise))((function(n,r){function o(t){try{h(i.next(t))}catch(t){r(t)}}function a(t){try{h(i.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}h((i=i.apply(t,e||[])).next())}))};const Y=864e13;class Q{constructor(t){this.app=t,this.id=null,this.username=void 0,this.password=null,this._disabled=void 0,this.displayName=null,this.email=void 0,this.emailAddressPending=void 0,this.phoneNumber=void 0,this.phoneNumberPending=void 0,this.country=void 0,this.locale=null,this.created=0,this.modified=0,this.emailVerified=void 0,this.phoneVerified=void 0,this.hasPassword=!1,this.thirdPartyAccounts={},this.customInfo={},this.accessToken=null,this.expiresAt=null,this.scope=void 0}getID(){return this.id}getUUID(){return this.id}getUsername(){return this.username}setUsername(t){const e=I(t);if(!E(e))throw new n(void 0,this);this.username=e}disabled(){return this._disabled}getDisplayName(){return this.displayName}setDisplayName(t){if(!(t=>"string"==typeof t&&t.length>=1&&t.length<=50)(t))throw new r(void 0,this);this.displayName=t}isPseudoUser(){return null!=this.hasPassword?!this.hasPassword:null!=this.username||null!=this.email||null!=this.phoneNumber}getEmailAddress(){return this.email}getPendingEmailAddress(){return this.emailAddressPending}getPhoneNumber(){return this.phoneNumber}getPendingPhoneNumber(){return this.phoneNumberPending}getEmailVerified(){return this.emailVerified}getPhoneVerified(){return this.phoneVerified}getCountry(){return this.country}setCountry(t){if(!this.country||!N(this.country))throw new p(void 0,void 0);this.country=t}getLocale(){return this.locale}setLocale(t){this.locale=t}getCreated(){return this.created}isEmailVerified(){return this.emailVerified}isPhoneVerified(){return this.phoneVerified}getLinkedSocialAccounts(){return null}getAccessToken(){return this.accessToken}getAccessTokenObject(){return this.accessToken?{access_token:this.accessToken,expires_at:this.expiresAt}:null}getScope(){return this.scope}setScope(t){this.scope=t}objectURI(){let t=null;return this.id&&(t=`kiicloud://users/${this.getID()}`),t}set(t,e){U(t)&&"_"!=t.substr(0,1)&&(this.customInfo[t]=e)}get(t){return this.customInfo[t]}getPath(){return`/users/${this.id}`}static getCurrentUser(t=At.globalApp){return t.getCurrentUser()}static userWithUsername(t,e,s=At.globalApp){const i=new Q(s);return i.setUsername(t),i.setPassword(e),i}static userWithPhoneNumber(t,e,s=At.globalApp){const i=new Q(s);return i.setPhoneNumber(t),i.setPassword(e),i}static userWithPhoneNumberAndUsername(t,e,s,i=At.globalApp){const n=new Q(i);return n.setUsername(e),n.setPassword(s),n.setPhoneNumber(t),n}static userWithEmailAddress(t,e,s=At.globalApp){const i=new Q(s);return i.setPassword(e),i.setEmailAddress(t),i}static userWithEmailAddressAndUsername(t,e,s,i=At.globalApp){const n=new Q(i);return n.setUsername(e),n.setPassword(s),n.setEmailAddress(t),n}static userWithEmailAddressAndPhoneNumber(t,e,s,i=At.globalApp){const n=new Q(i);return n.setPassword(s),n.setEmailAddress(t),n.setPhoneNumber(e),n}static userWithCredentials(t,e,s,i,n=At.globalApp){const r=new Q(n);return r.setUsername(s),r.setPassword(i),r.setEmailAddress(t),r.setPhoneNumber(e),r}static userWithID(t,e=At.globalApp){const s=new Q(e);return s.setId(t),s}static userWithURI(t,e=At.globalApp){const s=new Q(e),i=Q.validateURI(t);if(!i)throw new d(void 0,void 0);return s.setId(i),s}bucketWithName(t){return new ft(t,this,this.app)}encryptedBucketWithName(t){return new wt(t,this,this.app)}getACLEntityString(){return`UserID:${this.getID()}`}static authenticate(t,e,n=At.globalApp){return J(this,void 0,void 0,(function*(){if(!O(e))throw new s("Invalid Password pattern set",void 0);if(!z(t))throw new i("Invalid User Identifier set",void 0);const r=yield Z(t,e,n),o=new Q(n);if(o.setId(r.userId),o.accessToken=r.accessToken,n.setCurrentUser(o,r.accessToken),r.expiresAt){const t=(new Date).getTime(),e=S(r.expiresAt,t);o.setExpiresAt(e)}return r.scope&&o.setScope(r.scope),o}))}static authenticateWithToken(t,e,s=At.globalApp){return J(this,void 0,void 0,(function*(){const i=`/apps/${s.getAppID()}/users/me`,n=s.newRequest("GET",i);n.isSendAccessToken(!1),n.addHeader("Authorization",`Bearer ${t}`);const r=yield n.send();if(200!=r.status)throw g(0,r,void 0,null);const o=new Q(s);return void 0===e?o.setExpiresAt(new Date(Y)):o.setExpiresAt(e),o.updateWithJSON(r.body),o.accessToken=t,s.setCurrentUser(o,t),o}))}static authenticateWithTotp(t,e=At.globalApp){return J(this,void 0,void 0,(function*(){const s={grant_type:"mfa",totp_code:t},i=`/apps/${e.getAppID()}/oauth2/token`,n=e.newRequest("POST",i),r=yield n.send(JSON.stringify(s));if(200!=r.status)throw g(0,r,new Q(e),null);const o=new Q(e);return o.updateWithJSON(r.body),o}))}static authenticateWithRecoveryCode(t,e=At.globalApp){return J(this,void 0,void 0,(function*(){const s={grant_type:"mfa",recovery_code:t},i=`/apps/${e.getAppID()}/oauth2/token`,n=e.newRequest("POST",i),r=yield n.send(JSON.stringify(s));if(200!=r.status)throw g(0,r,new Q(e),null);const o=new Q(e);return o.updateWithJSON(r.body),o}))}register(){return J(this,void 0,void 0,(function*(){const t=this.password;if(null==t)throw k("password is not set",this);const e=`/apps/${this.app.getAppID()}/users`,s={password:this.password};if(null!==this.username&&(s.loginName=this.username),null!==this.displayName&&(s.displayName=this.displayName),null!==this.email&&(s.emailAddress=this.email),null!==this.phoneNumber&&(s.phoneNumber=this.phoneNumber),!X(this.phoneNumber,this.country))throw"needs to provide country for the local phone number";null!==this.country&&(s.country=this.country),null!==this.locale&&(s.locale=this.locale);for(let t in this.customInfo)s[t]=this.customInfo[t];const i=this.app.newRequest("POST",e);let n;i.isSendAccessToken(!1),i.setContentType("application/vnd.kii.RegistrationRequest+json");try{n=yield i.send(JSON.stringify(s))}catch(t){throw this.clearPassword(),t}if(201!=n.status)throw g(0,n,this,null);this.updateWithJSON(n.body);const r=this.findUserIdentifer(),o=yield Z(r,t,this.app);if(this.accessToken=o.accessToken,this.setId(o.userId),this.app.setCurrentUser(this,o.accessToken),o.expiresAt){const t=(new Date).getTime(),e=S(o.expiresAt,t);this.setExpiresAt(e)}return o.scope&&this.setScope(o.scope),this.clearPassword(),this}))}static registerAsPseudoUser(t={},e=At.globalApp){return J(this,arguments,void 0,(function*(){C(arguments[0])&&(t=arguments[1],e=arguments[2]||At.globalApp);const s=`/apps/${e.getAppID()}/users`,i=e.newRequest("POST",s);i.addHeader("x-kii-sdk",kt.getSDKClientInfo()),i.setContentType("application/vnd.kii.RegistrationAndAuthorizationRequest+json"),i.isSendAccessToken(!1),null===t&&(t={});const n=yield i.send(JSON.stringify(t));if(y(n.status)){const t=n.body._accessToken,s=new Q(e);return s.accessToken=t,s.updateWithJSON(n.body),s.setExpiresAt(new Date(Y)),e.setCurrentUser(s,t),s}throw g(0,n,void 0,null)}))}putIdentity(t,e,s={},i=[]){return J(this,void 0,void 0,(function*(){if(!this.isPseudoUser())throw new c("This user has the identity already",this);const n=this.app.getCurrentUser();if(null==n||null==n.getAccessToken())throw new c("User is not logged in",this);if(tt(t),!et(t))throw new c("needs to provide at least one of login name, email address or phone number",this);if(!O(e))throw new c("invalid password",this);const r=null==s?void 0:s.country;if(null!=(null==t?void 0:t.phoneNumber)&&!this.isValidLocalPhoneNumber(t.phoneNumber,r))throw new c("needs to provide country for the local phone number",this);const o=yield this.refresh();if(!o.isPseudoUser())throw new c("This user has the identity already",this);const a=it(o.customInfo);null!=t.emailAddress&&(a.emailAddress=t.emailAddress),null!=t.phoneNumber&&(a.phoneNumber=t.phoneNumber),null!=t.username&&(a.loginName=t.username),a.password=e,Object.assign(a,s),null==i||i.forEach((t=>{delete a[t]}));const h=`/apps/${this.app.getAppID()}/users/${this.getID()}`,u=this.app.newRequest("POST",h);u.setContentType("application/vnd.kii.UserUpdateRequest+json");const d=yield u.send(JSON.stringify(a));if(y(d.status))return o.setModified(d.body.modifiedAt),o.updateWithIdentifier(t),o.updateWithUserFields(s,i),o;throw g(0,d,this,null)}))}update(t={},e={},s=[]){return J(this,void 0,void 0,(function*(){const i=this.app.getCurrentUser();if(null==i||null==i.getAccessToken())throw new c("User is not logged in",this);const n=et(t);if(!((t,e,s,i)=>(tt(t),!!i||!!(e&&Object.keys(e).length>0)||s.length>0))(t,e,s,n))throw new c("all arguments are null or empty",this);const r=null==e?void 0:e.country;if(null!=(null==t?void 0:t.phoneNumber)&&!this.isValidLocalPhoneNumber(t.phoneNumber,r))throw new c("needs to provide country for the local phone number",this);const o=yield this.refresh();if(o.isPseudoUser()&&n)throw new c("Pseudo user must use putIdentity()",this);const a=it(o.customInfo);null!=(null==t?void 0:t.emailAddress)&&(a.emailAddress=t.emailAddress),null!=(null==t?void 0:t.phoneNumber)&&(a.phoneNumber=t.phoneNumber),null!=(null==t?void 0:t.username)&&(a.loginName=t.username),Object.assign(a,e),(null==s?void 0:s.length)>0&&s.forEach((t=>{delete a[t]}));const h=`/apps/${this.app.getAppID()}/users/${this.getID()}`,u=this.app.newRequest("POST",h);u.setContentType("application/vnd.kii.UserUpdateRequest+json");const d=yield u.send(JSON.stringify(a));if(y(d.status))return o.setModified(d.body.modifiedAt),o.updateWithIdentifier(t),o.updateWithUserFields(e,s),o;throw g(0,d,this,null)}))}updatePassword(t,e){return J(this,void 0,void 0,(function*(){if(!O(e))throw new s("Invalid password",this);const i=`/apps/${this.app.getAppID()}/users/${this.getID()}/password`,n={oldPassword:t,newPassword:e},r=this.app.newRequest("PUT",i);r.setContentType("application/vnd.kii.ChangePasswordRequest+json");const o=yield r.send(JSON.stringify(n));if(this.clearPassword(),y(o.status))return this;throw g(0,o,this,null)}))}static resetPassword(t,e=At.globalApp){return J(this,void 0,void 0,(function*(){if(!v(t))throw new c("Invalid user identifier. Must be a valid email address",void 0);const s=`/apps/${e.getAppID()}/users/EMAIL:${t}/password/request-reset`,i=e.newRequest("POST",s);i.isSendAccessToken(!1);const n=yield i.send();if(!y(n.status))throw g(0,n,void 0,null)}))}static resetPasswordWithNotificationMethod(t,e,s=At.globalApp){return J(this,void 0,void 0,(function*(){if("string"!=typeof t)throw new c("given userIdentifier is not string",void 0);if(0==t.length)throw new c("given userIdentifier is empty",void 0);if("EMAIL"!==e&&"SMS"!==e&&"SMS_PIN"!==e)throw new c("notificationMethod should be 'EMAIL' or 'SMS' or 'SMS_PIN'",void 0);const i=(t=>v(t)?`EMAIL:${t}`:A(t)?`PHONE:${t}`:t)(t),n=`/apps/${s.getAppID()}/users/${i}/password/request-reset`,r={notificationMethod:e};"SMS_PIN"==e&&(r.notificationMethod="SMS",r.smsResetMethod="PIN");const o=s.newRequest("POST",n);o.addHeader("x-kii-sdk",kt.getSDKClientInfo()),o.isSendAccessToken(!1),o.setContentType("application/vnd.kii.ResetPasswordRequest+json");const a=yield o.send(JSON.stringify(r));if(!y(a.status))throw g(0,a,void 0,null)}))}static completeResetPassword(t,e,s,i=At.globalApp){return J(this,void 0,void 0,(function*(){if(0==t.length)throw new c("given userIdentifier is null or empty",void 0);if(0==e.length)throw new c("given pinCode is null or empty",void 0);const n=st(t),r=`/apps/${i.getAppID()}/users/${n}/password/complete-reset`,o={pinCode:e};null!=s&&s.length>0&&(o.newPassword=s);const a=i.newRequest("POST",r);a.addHeader("x-kii-sdk",kt.getSDKClientInfo()),a.setContentType("application/vnd.kii.CompletePasswordResetRequest+json");const h=yield a.send(JSON.stringify(o));if(!y(h.status))throw g(0,h,void 0,null)}))}verifyCredentials(t,e){return J(this,void 0,void 0,(function*(){const s=`/apps/${this.app.getAppID()}/users/me/${t}/verify`,i={verificationCode:e},n=this.app.newRequest("POST",s);n.setContentType("application/vnd.kii.AddressVerificationRequest+json");const r=yield n.send(JSON.stringify(i));if(y(r.status))return"email-address"==t?this.setEmailVerified(!0):"phone-number"==t&&this.setPhoneVerified(!0),this;throw g(0,r,this,null)}))}verifyPhoneNumber(t){return this.verifyCredentials("phone-number",t)}resendVerification(t){return J(this,void 0,void 0,(function*(){const e=`/apps/${this.app.getAppID()}/users/${this.getID()}/${t}/resend-verification`,s=this.app.newRequest("POST",e),i=yield s.send();if(!y(i.status))throw g(0,i,this,null)}))}resendEmailVerification(){return this.resendVerification("email-address")}resendPhoneNumberVerification(){return this.resendVerification("phone-number")}memberOfGroups(){const t=`/apps/${this.app.getAppID()}/groups/?is_member=${this.getID()}`;return this.fetchGroups(t)}ownerOfGroups(){const t=`/apps/${this.app.getAppID()}/groups/?owner=${this.getID()}`;return this.fetchGroups(t)}fetchGroups(t){return J(this,void 0,void 0,(function*(){const e=this.app.newRequest("GET",t);e.addHeader("Accept","application/vnd.kii.GroupsRetrievalResponse+json");const s=yield e.send();if(y(s.status))return s.body.groups.map((t=>x.groupWithJSON(t)));throw g(0,s,this,null)}))}changePhone(t){return J(this,void 0,void 0,(function*(){const e=`/apps/${this.app.getAppID()}/users/${this.getID()}/phone-number`,s={phoneNumber:t},i=this.app.newRequest("PUT",e);i.setContentType("application/vnd.kii.PhoneNumberModificationRequest+json");const n=yield i.send(JSON.stringify(s));if(y(n.status))return this;throw g(0,n,this,null)}))}changeEmail(t){return J(this,void 0,void 0,(function*(){if(!v(t))throw new c("Invalid email address format",this);const e=`/apps/${this.app.getAppID()}/users/${this.getID()}/email-address`,s={emailAddress:t},i=this.app.newRequest("PUT",e);i.setContentType("application/vnd.kii.EmailAddressModificationRequest+json");const n=yield i.send(JSON.stringify(s));if(y(n.status))return this;throw g(0,n,this,null)}))}save(){return J(this,void 0,void 0,(function*(){const t=`/apps/${this.app.getAppID()}/users/${this.getID()}`,e=it(this.customInfo);null!=this.country&&(e.country=this.country),null!=this.locale&&(e.locale=this.locale),null!=this.displayName&&(e.displayName=this.displayName);const s=this.app.newRequest("POST",t);s.setContentType("application/vnd.kii.UserUpdateRequest+json");const i=yield s.send(JSON.stringify(e));if(y(i.status))return this.setModified(i.body.modifiedAt),this;throw g(0,i,this,null)}))}refresh(){return J(this,void 0,void 0,(function*(){const t=`/apps/${this.app.getAppID()}/users/${this.id}`,e=this.app.newRequest("GET",t),s=yield e.send();if(200!=s.status)throw g(0,s,this,null);return s.status<300&&s.status>=200&&(this.phoneNumberPending=null,this.emailAddressPending=null,this.updateWithJSON(s.body)),this}))}delete(){return J(this,void 0,void 0,(function*(){const t=`/apps/${this.app.getAppID()}/users/${this.id}`,e=this.app.newRequest("DELETE",t),s=yield e.send();if(y(s.status))return this;throw g(0,s,this,null)}))}static logOut(t=At.globalApp){t.logOut()}static loggedIn(t=At.globalApp){return t.loggedIn()}static findUserByEmail(t,e=At.globalApp){const s=e.getCurrentUser();if(null==s||null==s.getAccessToken())throw new c("User is not logged in",void 0);if(0==t.length)throw new c("email should not null or empty",void 0);const i=`/apps/${e.getAppID()}/users/EMAIL:${t}`;return Q.findUser(i,e)}static findUserByPhone(t,e=At.globalApp){const s=e.getCurrentUser();if(null==s||null==s.getAccessToken())throw new c("User is not logged in",void 0);if(0==t.length)throw new c("phone should not null or empty",void 0);const i=`/apps/${e.getAppID()}/users/PHONE:${t}`;return Q.findUser(i,e)}static findUserByUsername(t,e=At.globalApp){const s=e.getCurrentUser();if(null==s||null==s.getAccessToken())throw new c("User is not logged in",void 0);if(0==t.length)throw new c("username should not null or empty",void 0);const i=`/apps/${e.getAppID()}/users/LOGIN_NAME:${t}`;return Q.findUser(i,e)}static findUserByUsernameWithoutLogin(t,e=At.globalApp){const s=`/apps/${e.getAppID()}/users/LOGIN_NAME:${t}`;return Q.findUser(s,e)}static findUserByEmailWithoutLogin(t,e=At.globalApp){const s=`/apps/${e.getAppID()}/users/EMAIL:${t}`;return Q.findUser(s,e)}static findUserByPhoneWithoutLogin(t,e=At.globalApp){const s=`/apps/${e.getAppID()}/users/PHONE:${t}`;return Q.findUser(s,e)}static findUser(t,e){return J(this,void 0,void 0,(function*(){const s=e.newRequest("GET",t);s.addHeader("x-kii-sdk",kt.getSDKClientInfo());const i=yield s.send();if(y(i.status)){const t=new Q(e);return t.updateWithJSON(i.body),t}throw g(0,i,void 0,null)}))}topicWithName(t){if(0==t.length)throw new c("topicName should not null or empty",this);const e=this.getID();if(null==e||0==e.length)throw new c("can not instantiate topic from instance which doesn't have ID",this);const s=`/users/${this.getID()}`;return new L(s,t,this.app)}listTopics(t){return J(this,void 0,void 0,(function*(){let e=`/apps/${this.app.getAppID()}/users/${this.getID()}/topics`;t&&t.length>0&&(e+=`?paginationKey=${encodeURIComponent(t)}`);const s=this.app.newRequest("GET",e),i=yield s.send();if(y(i.status)){const t=i.body.paginationKey||null;return[i.body.topics.map((t=>this.topicWithName(t.topicID))),t]}throw g(0,i,this,null)}))}pushSubscription(){return new F(this,this.app)}pushInstallation(){if(this.app.isAdmin())throw new l("UnsupportedOperationException: Push installation is not supported by admin context",this);return new H(this,this.app)}setId(t){this.id=t}setExpiresAt(t){this.expiresAt=t}updateWithJSON(t){const e=t=>"userID"==t||"id"==t,s=t=>"created"==t||"createdAt"==t||"_created"==t,i=t=>"modified"==t||"modifiedAt"==t||"_modified"==t,n=t=>"_"!=t.substr(0,1),r={};for(let o in t){const a=t[o];switch(e(o)?this.id=a:s(o)?this.created=a:i(o)&&(this.modified=a),o){case"loginName":this.username=a;break;case"displayName":this.displayName=a;break;case"country":this.country=a;break;case"locale":this.locale=a;break;case"emailAddress":this.email=a;break;case"_emailAddressPending":this.emailAddressPending=a;break;case"phoneNumber":this.phoneNumber=a;break;case"_phoneNumberPending":this.phoneNumberPending=a;break;case"emailAddressVerified":this.emailVerified=a;break;case"phoneNumberVerified":this.phoneVerified=a;break;case"_hasPassword":this.hasPassword=a;break;case"_thirdPartyAccounts":if(null!=a.hotmail){const t=a.hotmail;t.type="live",a.live=t,delete a.hotmail}this.thirdPartyAccounts=a;break;case"_disabled":this._disabled=a;break;case"":r[""]=a;break;default:n(o)&&(r[o]=a)}}this.customInfo=r}setPassword(t){if(!O(t))throw new s("Invalid password",this);this.password=t}setEmailAddress(t){const e=I(t);if(!v(e))throw new a("Invalid Email Address",this);this.email=e}setPhoneNumber(t){if(!T(t))throw new o("Invalid Phone",this);this.phoneNumber=t}setLocalPhone(t,e){if(!D(t))throw new o("Invalid Phone",this);if(this.phoneNumber=t,!N(e))throw new p("Invalid Coruntry",this);this.country=e}static validateURI(t){const e=/^kiicloud:\/\/users\/(.*$)/i;if("string"==typeof(t=I(t))){const s=t.match(e);if(s)return s[1]}return null}validateURI(t){const e=/^kiicloud:\/\/users\/(.*$)/i;if("string"==typeof(t=I(t))){const s=t.match(e);if(s)return s[1]}return null}clearPassword(){this.password=null}findUserIdentifer(){if(null!=this.username)return this.username;if(null!=this.email&&1==this.emailVerified)return this.email;if(null!=this.phoneNumber&&1==this.phoneVerified)return this.phoneNumber;if(null!=this.email)return this.email;if(null!=this.phoneNumber)return this.phoneNumber;throw new c("No identifier",this)}isValidLocalPhoneNumber(t,e){return!!A(t)||null!=e&&X(t,e)}setModified(t){this.modified=t}updateWithIdentifier(t){null!=(null==t?void 0:t.username)&&(this.username=t.username),null!=(null==t?void 0:t.emailAddress)&&(this.email=t.emailAddress),null!=(null==t?void 0:t.phoneNumber)&&(this.phoneNumberPending=t.phoneNumber)}updateWithUserFields(t,e){for(let e in t){const s=t[e];switch(e){case"displayName":this.displayName=s;break;case"country":this.country=s;break;case"locale":this.locale=s;break;case"":this.customInfo[""]=s;break;default:"_"!=e.substr(0,1)&&(this.customInfo[e]=s)}}null==e||e.forEach((t=>{delete this.customInfo[t]}))}setEmailVerified(t){this.emailVerified=t}setPhoneVerified(t){this.phoneVerified=t}}const X=(t,e)=>!(void 0!==t&&!A(t))||null!=e&&N(e),z=t=>!!v(t)||!!T(t)||!!E(t),Z=(t,e,s)=>J(void 0,void 0,void 0,(function*(){const i={username:t,password:e};if(s.getAccessTokenExpiration()>0){const t=(new Date).getTime();i.expiresAt=R(s.getAccessTokenExpiration(),t)}const n=s.newRequest("POST","/oauth2/token");n.isSendAccessToken(!1);const r=yield n.send(JSON.stringify(i));if(200!=r.status)throw g(0,r,void 0,null);return{userId:r.body.id,accessToken:r.body.access_token,expiresAt:r.body.expires_in,scope:r.body.scope}})),tt=t=>{if(t){if(t.emailAddress&&null!=t.emailAddress&&!v(t.emailAddress))throw new c("invalid email",void 0);if(t.phoneNumber&&null!=t.phoneNumber&&!T(t.phoneNumber))throw new c("invalid phone number",void 0);if(t.username&&null!=t.username&&!E(t.username))throw new c("invalid username",void 0)}},et=t=>null!==t&&(null!=t.emailAddress||null!=t.phoneNumber||null!=t.username),st=t=>v(t)?`EMAIL:${t}`:A(t)?`PHONE:${t}`:t,it=t=>JSON.parse(JSON.stringify(t));var nt=function(t,e,s,i){return new(s||(s=Promise))((function(n,r){function o(t){try{h(i.next(t))}catch(t){r(t)}}function a(t){try{h(i.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}h((i=i.apply(t,e||[])).next())}))};const rt={KiiACLBucketActionCreateObjects:"CREATE_OBJECTS_IN_BUCKET",KiiACLBucketActionQueryObjects:"QUERY_OBJECTS_IN_BUCKET",KiiACLBucketActionDropBucket:"DROP_BUCKET_WITH_ALL_CONTENT",KiiACLBucketActionReadObjects:"READ_OBJECTS_IN_BUCKET",KiiACLObjectActionRead:"READ_EXISTING_OBJECT",KiiACLObjectActionWrite:"WRITE_EXISTING_OBJECT",KiiACLSubscribeToTopic:"SUBSCRIBE_TO_TOPIC",KiiACLSendMessageToTopic:"SEND_MESSAGE_TO_TOPIC"};class ot{constructor(t,e){this.parent=t,this.app=e,this.entriesMap={}}aclPath(){return`${this.parent.getPath()}/acl`}listACLEntries(){return nt(this,void 0,void 0,(function*(){const t=`/apps/${this.app.getAppID()}${this.aclPath()}`,e=this.app.newRequest("GET",t),s=yield e.send();if(y(s.status)){const t=[];return Object.keys(s.body).forEach((e=>{s.body[e].forEach((s=>{const i=ht(s);null!=i&&t.push(at.entryWithSubject(i,e))}))})),t}throw g(0,s,this,null)}))}putACLEntry(t){this.entriesMap[t.toKey()]=t}removeACLEntry(t){return delete this.entriesMap[t.toKey()],this}save(){return nt(this,void 0,void 0,(function*(){const t=Object.keys(this.entriesMap);if(0==t.length)throw k("There is no entry to save.",this);for(let e=0;e<t.length;e++){const s=this.entriesMap[t[e]],i=`/apps/${this.app.getAppID()}${this.aclPath()}/${s.getActionString()}/${s.getEntityString()}`,n=this.app.newRequest(s.getGrant()?"PUT":"DELETE",i),r=yield n.send();if(!y(r.status))throw g(0,r,this,null);this.removeACLEntry(s)}return this}))}static aclWithParent(t,e=At.globalApp){return new ot(t,e)}}class at{constructor(t,e){this.subject=t,this.action=e,this.grant=!0}setAction(t){this.action=t}getAction(){return this.action}setSubject(t){this.subject=t}getSubject(){return this.subject}setGrant(t){return this.grant=t,this}getGrant(){return this.grant}toKey(){return`${this.getActionString()}/${this.getEntityString()}/${this.grant}`}static entryWithSubject(t,e){return new at(t,e)}getActionString(){return this.action}getEntityString(){return this.subject.getACLEntityString()}}const ht=t=>{if(null!=t.groupID){const e=t.groupID;return x.groupWithID(e)}if(null!=t.userID){const e=t.userID;return Q.userWithID(e)}return null!=t.thingID?Q.userWithID(""):null};class ut{constructor(t,e){this.segments=t,this.app=e}isUser(){return 1==this.segments.length&&"users"==this.segments[0].type}isObject(){return"objects"==this.segments[this.segments.length-1].type}toEntity(){let t=null;for(let e=0;e<this.segments.length;e++){const s=this.segments[e];if("users"==s.type){if(null!=t)throw new Error("Invalid uri");t=Q.userWithID(s.value,this.app)}else if("groups"==s.type){if(null!=t)throw new Error("Invalid uri");t=x.groupWithID(s.value,this.app)}else if("buckets"==s.type){if(t instanceof ft||t instanceof dt)throw new Error("Invalid owner");const e=t;t=new ft(s.value,e,this.app)}else if("objects"==s.type){if(!(t instanceof ft))throw new Error("parent is not bucket");const e=t.createObjectWithID(s.value);t=e}else{if("things"!=s.type)throw new Error(`unsupported entity type: ${s.type}`);t=V.thingWithID(s.value)}}if(null==t)throw new Error("empty uri");return t}toMoveBodyParam(){if(!this.isObject())throw new Error("uri is not object.");const t=this.segments.find((t=>"buckets"==t.type));if(void 0===t)throw new Error("bucket not found in uri.");const e=t.value,s=this.segments.find((t=>"objects"==t.type));if(void 0===s)throw new Error("bucket not found in uri.");const i=s.value,n=this.toTargetData(this.segments[0]);return 0==e.indexOf("CRYPTO:")?{targetObjectScope:n,targetBucketType:"crypto",targetBucketID:e.replace("CRYPTO:",""),targetObjectID:i}:{targetObjectScope:n,targetBucketID:e,targetObjectID:i}}toTargetData(t){if("users"==t.type)return{appID:this.app.getAppID(),userID:t.value,type:"APP_AND_USER"};if("groups"==t.type)return{appID:this.app.getAppID(),groupID:t.value,type:"APP_AND_GROUP"};if("things"==t.type)throw new Error("unsupported move target.");return{appID:this.app.getAppID(),type:"APP"}}static parse(t,e=At.globalApp){if(0!=t.indexOf("kiicloud://"))throw new Error("scheme is not kiicloud");const s=t.substr("kiicloud://".length).split("/");s.length%2==1&&s.push("");let i=[];for(let t=0;t<s.length;t+=2){const e={type:s[t],value:s[t+1]};i.push(e)}return new ut(i,e)}}var ct=function(t,e,s,i){return new(s||(s=Promise))((function(n,r){function o(t){try{h(i.next(t))}catch(t){r(t)}}function a(t){try{h(i.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}h((i=i.apply(t,e||[])).next())}))};class dt{constructor(t,e,s){this.bucket=t,this.id=e,this.app=s,this.created=0,this.modified=0,this.objectType=null,this.bodyContentType="",this.owner=null,this.customInfo={},this.patch={},this.etag=""}getPath(){let t=this.bucket.getPath()+"/objects/";return this.id&&(t+=this.id),t}getUUID(){return this.id}setUUID(t){this.id=t}getID(){return this.id}getCreated(){return this.created}getModified(){return this.modified}getObjectType(){return this.objectType}setObjectType(t){this.objectType=t}setBucket(t){this.bucket=t}setObjectTypeFromResponse(t){"application/json"==t&&(this.objectType=null);const e=t.match(new RegExp(`application/vnd.${this.app.getAppID()}.([^.+]+)+json`));null!=e&&(this.objectType=e[1])}getBucket(){return this.bucket}getBodyContentType(){return this.bodyContentType}set(t,e){U(t)&&0!=t.indexOf("_")&&(this.patch[t]=e)}get(t){return void 0!==this.patch[t]?this.patch[t]:this.customInfo[t]}getKeys(){const t=Object.keys(this.customInfo);return Object.keys(this.customInfo).forEach((e=>{void 0===this.customInfo[e]&&t.push(e)})),t}remove(t){delete this.customInfo[t],delete this.patch[t]}setGeoPoint(t,e){if(null===t||""===t)throw new u("Specified key is invalid",this);if(!(e instanceof $t))throw new u("Specified latitide or longitude is invalid",this);this.patch[t]=e.toObject()}getGeoPoint(t){const e=this.customInfo[t];return $t.fromObject(e)}objectACL(){return ot.aclWithParent(this,this.app)}objectURI(){return this.bucket&&this.id?`kiicloud:/${this.bucket.getPath()}/objects/${this.id}`:null}_getToken(){const t=Q.getCurrentUser();return(t?t.getAccessToken():null)||null}saveAllFields(t=!0){return ct(this,arguments,void 0,(function*(){null===arguments[0]&&(t=arguments[1]);const e={};return Object.assign(e,this.customInfo),Object.assign(e,this.patch),null==this.getID()?yield this.performCreate(e):yield this.performUpdate(e,t),this.customInfo=e,this.patch={},this}))}save(t=!0){return ct(this,arguments,void 0,(function*(){null===arguments[0]&&(t=arguments[1]);const e={};return Object.assign(e,this.patch),null==this.getID()?(yield this.performCreate(e),Object.assign(this.customInfo,this.patch)):yield this.performPatchUpdate(e,t),this.patch={},this}))}performCreate(t){var e,s;return ct(this,void 0,void 0,(function*(){const i=`/apps/${this.app.getAppID()}${this.bucket.getPath()}/objects`,n=this.app.newRequest("POST",i);null==this.objectType?n.setContentType("application/json"):n.setContentType(`application/vnd.${this.app.getAppID()}.${this.objectType}+json`);const r=yield n.send(JSON.stringify(t));if(!y(r.status))throw g(0,r,this,null);{this.etag=null!==(s=null===(e=r.headers)||void 0===e?void 0:e.get("etag"))&&void 0!==s?s:"";const t=r.body.objectID;if(null==t)throw k("No objectID response",this);this.id=t,null!=r.body.createdAt&&(this.created=r.body.createdAt);const i=r.body.dataType;this.modified=this.created,null!=i&&this.setObjectTypeFromResponse(i)}}))}performUpdate(t,e){var s,i;return ct(this,void 0,void 0,(function*(){if(null==this.getID())throw k("empty object ID",this);const n=`/apps/${this.app.getAppID()}${this.bucket.getPath()}/objects/${this.getID()}`,r=this.app.newRequest("PUT",n),o=this.getCreated()>0;if(!e)if(o){if(0==this.etag.length)throw k("IllegalState! Call KiiObject#refresh() prior call this method.",this);r.addHeader("If-Match",this.etag)}else r.addHeader("If-None-Match","*");null==this.objectType?r.setContentType("application/json"):r.setContentType(`application/vnd.${this.app.getAppID()}.${this.objectType}+json"`);const a=yield r.send(JSON.stringify(t));if(!y(a.status))throw g(0,a,this,null);this.etag=null!==(i=null===(s=a.headers)||void 0===s?void 0:s.get("etag"))&&void 0!==i?i:"",null!=a.body.createdAt&&(this.created=a.body.createdAt),null!=a.body.modifiedAt&&(this.modified=a.body.modifiedAt)}))}performPatchUpdate(t,e){var s,i;return ct(this,void 0,void 0,(function*(){if(null==this.getID())throw k("empty object ID",this);const n=`/apps/${this.app.getAppID()}${this.bucket.getPath()}/objects/${this.getID()}`,r=this.app.newRequest("POST",n);r.addHeader("X-HTTP-Method-Override","PATCH");const o=this.getCreated()>0;if(!e)if(o){if(0==this.etag.length)throw k("IllegalState! Call KiiObject#refresh() prior call this method.",this);r.addHeader("If-Match",this.etag)}else{if(t&&!this.etag)throw k("IllegalState! Call KiiObject#refresh() prior call this method.",this);r.addHeader("If-None-Match","*")}null==this.objectType?r.setContentType("application/json"):r.setContentType(`application/vnd.${this.app.getAppID()}.${this.objectType}+json`);const a=yield r.send(JSON.stringify(t));if(!y(a.status))throw g(0,a,this,null);this.etag=null!==(i=null===(s=a.headers)||void 0===s?void 0:s.get("etag"))&&void 0!==i?i:"",this.updateWithJSON(a.body)}))}static objectWithBucket(t,e,s=At.globalApp){const i=new dt(t,void 0,s);return i.setObjectType(e),i}updateWithJSON(t,e=!0){e||(this.customInfo={});for(let e in t){const s=t[e];switch(e){case"_id":null==this.getID()&&(this.id=s);break;case"_created":this.created=s;break;case"_modified":this.modified=s;break;case"_owner":this.owner=Q.userWithID(s);break;case"_dataType":this.objectType=s;break;case"_calculated":this.customInfo[e]=s;break;case"_version":this.etag=s;break;default:"_"!=e[0]&&(this.customInfo[e]=s)}}}refresh(){var t,e;return ct(this,void 0,void 0,(function*(){if(null==this.getID())throw k("empty object ID",this);const s=`/apps/${this.app.getAppID()}${this.bucket.getPath()}/objects/${this.getID()}`,i=this.app.newRequest("GET",s),n=yield i.send();if(y(n.status))return this.etag=null!==(e=null===(t=n.headers)||void 0===t?void 0:t.get("etag"))&&void 0!==e?e:"",this.updateWithJSON(n.body,!1),this;throw g(0,n,this,null)}))}delete(){return ct(this,void 0,void 0,(function*(){if(null==this.getID())throw k("empty object ID",this);const t=`/apps/${this.app.getAppID()}${this.bucket.getPath()}/objects/${this.getID()}`,e=this.app.newRequest("DELETE",t),s=yield e.send();if(y(s.status))return this;throw g(0,s,this,null)}))}static objectWithURI(t,e=At.globalApp){let s,i;try{s=ut.parse(t,e),i=s.toEntity()}catch(t){throw k(t.message,this)}if(i instanceof dt)return i;throw k("uri is not for object.",void 0)}moveBody(t){return ct(this,void 0,void 0,(function*(){if(!t)throw new u("targetObjectUri is required",this);let e,s;try{e=ut.parse(t,this.app),s=e.toMoveBodyParam()}catch(t){throw k(t.message,this)}const i=`/apps/${this.app.getAppID()}${this.bucket.getPath()}/objects/${this.getID()}/body/move`,n=this.app.newRequest("POST",i);n.setContentType("application/vnd.kii.ObjectBodyMoveRequest+json");const r=yield n.send(JSON.stringify(s));if(y(r.status))return[this,t];throw g(0,r,this,{targetObjectUri:t})}))}uploadBody(t){return ct(this,void 0,void 0,(function*(){const e=`/apps/${this.app.getAppID()}${this.bucket.getPath()}/objects/${this.getID()}/body`,s=t.type.length>0?t.type:"application/octet-stream",i=this.app.newRequest("PUT",e);i.addHeader("x-kii-sdk",kt.getSDKClientInfo()),i.setContentType(s);const n=yield i.send(t);if(y(n.status)){const t=n.body.modifiedAt;return void 0!==t&&(this.modified=t),this.bodyContentType=s,this}{let t="failed to upload body. statusCode: "+n.status;throw n.body.errorCode&&(t+=" error code: "+n.body.errorCode),n.body.message&&(t+=" message: "+n.body.message),k(t,this)}}))}downloadBody(){var t,e;return ct(this,void 0,void 0,(function*(){const s=`/apps/${this.app.getAppID()}${this.bucket.getPath()}/objects/${this.getID()}/body`,i=this.app.newRequest("GET",s);i.addHeader("x-kii-sdk",kt.getSDKClientInfo());const n=yield i.sendForDownload();if(y(n.status)){const s=null!==(e=null===(t=n.headers)||void 0===t?void 0:t.get("content-type"))&&void 0!==e?e:"";return this.bodyContentType=s,n.body}{let t="failed to download body. statusCode: "+n.status;throw n.body&&(t+=" error code: "+n.body.errorCode),n.body.message&&(t+=" message: "+n.body.message),k(t,this)}}))}publishBody(){return ct(this,void 0,void 0,(function*(){return this.publish({})}))}publishBodyExpiresAt(t){return ct(this,void 0,void 0,(function*(){return this.publish({expiresAt:t})}))}publishBodyExpiresIn(t){return this.publish({expiresIn:t})}publish(t){return ct(this,void 0,void 0,(function*(){const e=`/apps/${this.app.getAppID()}${this.bucket.getPath()}/objects/${this.getID()}/body/publish`,s=this.app.newRequest("POST",e);s.setContentType("application/vnd.kii.ObjectBodyPublicationRequest+json"),s.addHeader("x-kii-sdk",kt.getSDKClientInfo());const i=yield s.send(JSON.stringify(t));if(y(i.status))return[this,i.body.url];{let t="failed to publish body. statusCode: "+i.status;throw i.body.errorCode&&(t+=" error code: "+i.body.errorCode),i.body.message&&(t+=" error message: "+i.body.message),k(t,this)}}))}deleteBody(){return ct(this,void 0,void 0,(function*(){const t=`/apps/${this.app.getAppID()}${this.bucket.getPath()}/objects/${this.getID()}/body`,e=this.app.newRequest("DELETE",t);e.addHeader("x-kii-sdk",kt.getSDKClientInfo());const s=yield e.send();if(y(s.status))return this.bodyContentType="",this;{let t="failed to delete body. statusCode: "+s.status;throw s.body&&(t+=" error code: "+s.body.errorCode),s.body.message&&(t+=" message: "+s.body.message),k(t,this)}}))}static isValidObjectID(t){return"string"==typeof t&&null!==t.match(/^[a-zA-Z0-9-_.]{2,100}$/i)}}class pt{constructor(){this.clause=void 0,this.paginationKey="",this.limit=0,this.sortField=void 0,this.sortDescending=void 0}static clone(t){const e=new pt;return e.clause=t.clause,e.limit=t.limit,e.sortField=t.sortField,e.sortDescending=t.sortDescending,e}getPaginationKey(){return this.paginationKey}setPaginationKey(t){this.paginationKey=t}setClause(t){this.clause=t}getLimit(){return this.limit}setLimit(t){this.limit=t}toDict(){const t={},e={};return this.paginationKey&&(t.paginationKey=this.paginationKey),this.limit>0&&(t.bestEffortLimit=this.limit),void 0!==this.sortDescending&&(e.descending=this.sortDescending),void 0===this.clause?e.clause={type:"all"}:e.clause=this.clause.toDict(),void 0!==this.sortField&&(e.orderBy=this.sortField),t.bucketQuery=e,t}static queryWithClause(t){const e=new pt;return null==t||e.setClause(t),e}sortByDesc(t){this.sortField=t,this.sortDescending=!0}sortByAsc(t){this.sortField=t,this.sortDescending=!1}}class lt{constructor(){this.whereClauses=[],this.whereType=""}toDict(){let t=null;if(this.whereClauses.length>0)if(this.whereType.length>0)if(1===this.whereClauses.length){const e=this.whereClauses[0];t="not"===this.whereType?{type:"not",clause:e.toDict()}:e.toDict()}else{const e=[];this.whereClauses.forEach((t=>{e.push(t.toDict())})),t={type:this.whereType,clauses:e}}else t=this.whereClauses[0].toDict();else this.dictExpression&&(t=this.dictExpression);return t||(t={type:"all"}),t}setWhereType(t){this.whereType=t}setWhereClauses(t){this.whereClauses=t}setDictValue(t){this.dictExpression=t}getWhereType(){return this.whereType}static createWithWhere(t,e){const s=new lt;return s.setWhereType(t),s.setWhereClauses(e),s}static create(t,e,s){const i=new lt;let n={};return"="===t?(n.type="eq",n.field=e,n.value=s):"<"===t?(n.type="range",n.field=e,n.upperLimit=s,n.upperIncluded=!1):"<="===t?(n.type="range",n.field=e,n.upperLimit=s,n.upperIncluded=!0):">"===t?(n.type="range",n.field=e,n.lowerLimit=s,n.lowerIncluded=!1):">="===t?(n.type="range",n.field=e,n.lowerLimit=s,n.lowerIncluded=!0):"in"===t?(n.type="in",n.field=e,n.values=s):"prefix"===t?(n.type="prefix",n.field=e,n.prefix=s):"hasField"===t&&(n.type="hasField",n.field=e,n.fieldType=s),i.setDictValue(n),i}static all(){return new lt}static and(...t){return this.createWithWhere("and",t)}static or(...t){return this.createWithWhere("or",t)}static not(t){return this.createWithWhere("not",[t])}static equals(t,e){return e.className&&(e=e.ObjectURI),lt.create("=",t,e)}static notEquals(t,e){return e.className&&(e=e.ObjectURI),this.createWithWhere("not",[lt.equals(t,e)])}static greaterThan(t,e){return lt.create(">",t,e)}static greaterThanOrEqual(t,e){return lt.create(">=",t,e)}static lessThan(t,e){return lt.create("<",t,e)}static lessThanOrEqual(t,e){return lt.create("<=",t,e)}static in(t,e){return lt.create("in",t,e)}static inClause(t,e){return lt.create("in",t,e)}static startsWith(t,e){return lt.create("prefix",t,e)}static geoDistance(t,e,s,i){if(!(t=>"string"==typeof t&&t.length>0)(t))throw new u("Specified key is not a string or is an empty string.",void 0);if(!((n=e)&&n instanceof $t))throw new u("center is not a reference of KiiGeoPoint.",void 0);var n;if(i&&null!=="^[a-zA-Z_][a-zA-Z0-9_]*$".match(i))throw new u("putDistanceInto is invalid.",void 0);if(""===i)throw new u("putDistanceInto is invalid.",void 0);if(isNaN(s)||s<=0||s>2e7)throw new u("radius is invalid.",void 0);const r=new lt;let o={type:"geodistance"};return o.field=t,e=e.toObject(),o.center=e,o.radius=s,o.putDistanceInto=i,r.setDictValue(o),r}static geoBox(t,e,s){const i=t=>!!t&&t instanceof $t;if(!(t=>"string"==typeof t&&t.length>0)(t))throw new u("Specified key is not a string or is an empty string.",void 0);if(!i(e)||!i(s))throw new u("northEast or southWest is not a reference of KiiGeoPoint.",void 0);const n=new lt;let r={type:"geobox"};r.field=t;const o=e.toObject(),a=s.toObject();return r.box={ne:o,sw:a},n.setDictValue(r),n}static hasField(t,e){if(!["STRING","INTEGER","DECIMAL","BOOLEAN"].includes(e))throw new u("fieldType is invalid.",void 0);return lt.create("hasField",t,e)}}var gt=function(t,e,s,i){return new(s||(s=Promise))((function(n,r){function o(t){try{h(i.next(t))}catch(t){r(t)}}function a(t){try{h(i.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}h((i=i.apply(t,e||[])).next())}))};class ft{constructor(t,e,s){if(this.bucketName=t,this.parent=e,this.app=s,!t)throw new u("Specified bucket name is null or empty.",void 0)}parentIs(t,e){return t instanceof e}getUser(){if(this.parentIs(this.parent,Q))return this.parent}getGroup(){if(this.parentIs(this.parent,x))return this.parent}getThing(){if(this.parentIs(this.parent,V))return this.parent}getParent(){return this.getUser()||this.getGroup()||this.getThing()}getBucketName(){return this.bucketName}getQualifiedBucketName(){return this.bucketName}createObject(){return new dt(this,void 0,this.app)}createObjectWithType(t){return dt.objectWithBucket(this,t,this.app)}createObjectWithID(t){if(!dt.isValidObjectID(t))throw new u("Specified obejctID is invalid.",this);return new dt(this,t,this.app)}getPath(){return null==this.parent?`/buckets/${this.getQualifiedBucketName()}`:`${this.parent.getPath()}/buckets/${this.getQualifiedBucketName()}`}acl(){return ot.aclWithParent(this,this.app)}executeQuery(t){return gt(this,void 0,void 0,(function*(){const e=`/apps/${this.app.getAppID()}${this.getPath()}/query`,s=t.toDict(),i=this.app.newRequest("POST",e);i.setContentType("application/vnd.kii.QueryRequest+json");const n=yield i.send(JSON.stringify(s));if(y(n.status)){const e=n.body.results.map((t=>{const e=this.createObject();return e.updateWithJSON(t),e}));let s=null;return null!=n.body.nextPaginationKey&&(s=pt.clone(t),s.setPaginationKey(n.body.nextPaginationKey)),[t,e,s]}throw g(0,n,this,null)}))}countWithQuery(t){return gt(this,void 0,void 0,(function*(){const e=`/apps/${this.app.getAppID()}${this.getPath()}/query`,s=null==t?pt.queryWithClause(null).toDict():t.toDict();s.bucketQuery.aggregations=[{type:"COUNT",putAggregationInto:"count_field"}],(null==t?void 0:t.getPaginationKey())&&(s.paginationKey=t.getPaginationKey());const i=this.app.newRequest("POST",e);i.setContentType("application/vnd.kii.QueryRequest+json");const n=yield i.send(JSON.stringify(s));if(y(n.status)){const e=n.body.aggregations.count_field;return[this,t,e]}throw g(0,n,this,null)}))}count(){return gt(this,void 0,void 0,(function*(){return this.countWithQuery(pt.queryWithClause(null))}))}delete(){return gt(this,void 0,void 0,(function*(){const t=`/apps/${this.app.getAppID()}${this.getPath()}`,e=this.app.newRequest("DELETE",t),s=yield e.send();if(!y(s.status))throw g(0,s,this,null)}))}}class wt extends ft{constructor(t,e,s){super(t,e,s)}getQualifiedBucketName(){return"CRYPTO:"+this.bucketName}}var yt=function(t,e,s,i){return new(s||(s=Promise))((function(n,r){function o(t){try{h(i.next(t))}catch(t){r(t)}}function a(t){try{h(i.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}h((i=i.apply(t,e||[])).next())}))};class mt{constructor(t){this.xhr=t}get(t){return this.xhr.getResponseHeader(t)}}class vt{create(t,e){return new bt(jQuery.ajaxSettings.xhr(),t,e)}}class It{create(t,e){return new Tt(t,e)}}class bt{constructor(t,e,s){this.xhr=t,this.url=s,this.sendAccessToken=!0,this.accessToken="",this.contentType="",t.open(e,s,!0)}onProgress(t){return this.progress=t,t}getUrl(){return this.url}setAccessToken(t){this.accessToken=t}addHeader(t,e){this.xhr.setRequestHeader(t,e)}isSendAccessToken(t){this.sendAccessToken=t}setContentType(t){this.contentType=t}send(t){return yt(this,void 0,void 0,(function*(){return new Promise(((e,s)=>{this.xhr.onerror=()=>{s()},this.xhr.onreadystatechange=()=>{if(this.xhr.readyState==XMLHttpRequest.DONE){const t=new mt(this.xhr);if(204==this.xhr.status)return void e({status:204,headers:t,body:{}});let s=null;try{s=JSON.parse(this.xhr.responseText)}catch(t){s=this.xhr.responseText}e({status:this.xhr.status,headers:t,body:s})}},this.xhr.onprogress=t=>t,this.xhr.responseType="text",this.contentType.length>0&&this.xhr.setRequestHeader("Content-Type",this.contentType),this.sendAccessToken&&this.accessToken&&this.xhr.setRequestHeader("authorization",`bearer ${this.accessToken}`),this.xhr.send(t)}))}))}sendForDownload(t){return yt(this,void 0,void 0,(function*(){return new Promise(((e,s)=>{this.xhr.onerror=()=>{s()},this.xhr.onreadystatechange=()=>{if(this.xhr.readyState==XMLHttpRequest.HEADERS_RECEIVED&&(200==this.xhr.status?this.xhr.responseType="blob":this.xhr.responseType="text"),this.xhr.readyState==XMLHttpRequest.DONE){const t=new mt(this.xhr);let s=null;if(204==this.xhr.status||200===this.xhr.status)return this.xhr.getResponseHeader("content-type"),s=this.xhr.response,void e({status:204,headers:t,body:s});try{s=JSON.parse(this.xhr.responseText)}catch(t){s=this.xhr.responseText}e({status:this.xhr.status,headers:t,body:s})}},this.contentType.length>0&&this.xhr.setRequestHeader("Content-Type",this.contentType),this.sendAccessToken&&this.accessToken&&this.xhr.setRequestHeader("authorization",`bearer ${this.accessToken}`),this.xhr.send(t)}))}))}}class Tt{constructor(t,e){this.method=t,this.url=e,this.sendAccessToken=!0,this.accessToken="",this.contentType="",this.headers=new Headers}getUrl(){return this.url}setAccessToken(t){this.accessToken=t}addHeader(t,e){this.headers.append(t,e)}isSendAccessToken(t){this.sendAccessToken=t}setContentType(t){this.contentType=t}onProgress(t){this.progress=t}send(t){return yt(this,void 0,void 0,(function*(){this.contentType.length>0&&this.headers.append("Content-Type",this.contentType),this.sendAccessToken&&this.accessToken&&this.headers.append("authorization",`bearer ${this.accessToken}`);const e=yield fetch(this.url,{method:this.method,headers:this.headers,body:t}),s=e.status;return 204==s?{status:s,body:{}}:{status:s,body:yield e.json()}}))}sendForDownload(t){return yt(this,void 0,void 0,(function*(){this.sendAccessToken&&this.accessToken&&this.headers.append("authorization",`bearer ${this.accessToken}`);const e=yield fetch(this.url,{method:this.method,headers:this.headers,body:t}),s=e.status;return 204==s?{status:s,body:new Blob}:{status:s,body:yield e.blob()}}))}}class At{constructor(t,e,s,i=!1){this.appId=t,this.appKey=e,this.baseURL=s,this.admin=i,this.expiresIn=0,this.currentUser=null,this.accessToken="",this.requestFactory=Dt()}isAdmin(){return this.admin}getAppID(){return this.appId}getAppKey(){return this.appKey}getBaseURL(){return this.baseURL}newRequest(t,e){const s=this.requestFactory.create(t,`${this.baseURL}${e}`);return s.addHeader("x-kii-appid",this.appId),s.addHeader("x-kii-appkey",this.appKey),s.addHeader("x-kii-sdk",kt.getSDKClientInfo()),this.accessToken&&s.setAccessToken(this.accessToken),s.setContentType("application/json"),s}setAccessTokenExpiration(t){this.expiresIn=t}getAccessTokenExpiration(){return this.expiresIn}setCurrentUser(t,e){this.currentUser=t,this.accessToken=e}getCurrentUser(){return this.currentUser}getAccessToken(){return this.accessToken}setAccessToken(t){this.accessToken=t}bucketWithName(t){return new ft(t,null,this)}encryptedBucketWithName(t){return new wt(t,null,this)}groupWithName(t){return x.groupWithJSON({name:t},this)}setRequestFactory(t){this.requestFactory=t}logOut(){this.currentUser=null,this.accessToken=""}loggedIn(){return null!=this.currentUser}listTopics(t=""){return e=this,s=void 0,n=function*(){let e=`/apps/${this.getAppID()}/topics`;"string"==typeof t&&""!==t&&(e=e+"?paginationKey="+encodeURIComponent(t));const s=this.newRequest("GET",e),i=yield s.send();if(!y(i.status))throw g(0,i,this,null);const n=i.body.paginationKey||null;return[i.body.topics.map((t=>new L("",t.topicID,this))),n]},new((i=void 0)||(i=Promise))((function(t,r){function o(t){try{h(n.next(t))}catch(t){r(t)}}function a(t){try{h(n.throw(t))}catch(t){r(t)}}function h(e){var s;e.done?t(e.value):(s=e.value,s instanceof i?s:new i((function(t){t(s)}))).then(o,a)}h((n=n.apply(e,s||[])).next())}));var e,s,i,n}}const Dt=()=>void 0!==t.g.jQuery?new vt:(t.g.fetch,new It);class Nt{constructor(t,e,s,i){this.entryName=t,this.version=e,this.environmentVersion=s,this.app=i}execute(t){var e,s,i,n,r,o;return i=this,n=void 0,o=function*(){if(!(null===(i=t)||"object"==typeof i&&Object.keys(i).length>0))throw new u("arugment is invalid",this);var i;const n=t||{},r=this.version||"current";let o=`/apps/${this.app.getAppID()}/server-code/versions/${r}/${this.entryName}`;this.environmentVersion&&(o+=`?environment-version=${this.environmentVersion}`);const a=this.app.newRequest("POST",o);this.app.getCurrentUser()||a.isSendAccessToken(!1),a.addHeader("x-kii-sdk",kt.getSDKClientInfo());const h=yield a.send(JSON.stringify(n));if(y(h.status)){const i=h.headers;if(null==i)throw k("Invalid response header",this);const n=Number(null!==(e=i.get("x-step-count"))&&void 0!==e?e:"0"),r=null!==(s=i.get("x-environment-version"))&&void 0!==s?s:"";return[this,t,new Ot(h.body,n,r)]}throw g(0,h,this,{argument:t})},new((r=void 0)||(r=Promise))((function(t,e){function s(t){try{h(o.next(t))}catch(t){e(t)}}function a(t){try{h(o.throw(t))}catch(t){e(t)}}function h(e){var i;e.done?t(e.value):(i=e.value,i instanceof r?i:new r((function(t){t(i)}))).then(s,a)}h((o=o.apply(i,n||[])).next())}))}getEntryName(){return this.entryName}}class Ot{constructor(t,e,s){this.returnObject=t,this.exeSteps=e,this.environmentVersion=s}getExecutedSteps(){return this.exeSteps}getEnvironmentVersion(){return this.environmentVersion}getReturnedValue(){return this.returnObject}}var Et=function(t,e,s,i){return new(s||(s=Promise))((function(n,r){function o(t){try{h(i.next(t))}catch(t){r(t)}}function a(t){try{h(i.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}h((i=i.apply(t,e||[])).next())}))};class _t{constructor(t){this.app=t}getApp(){return this.app}bucketWithName(t){return new ft(t,null,this.app)}encryptedBucketWithName(t){return new wt(t,null,this.app)}groupWithName(t){return x.groupWithName(t,this.app)}userWithID(t){return Q.userWithID(t,this.app)}objectWithURI(t){const e=0==t.indexOf("kiicloud://"),s=t.substr("kiicloud://".length).split("/"),i=s.length;if(i<4||!e)throw new d(void 0,this);const n=s[4===i?1:3];let r=null;if("groups"===s[0]&&6===i)r=x.groupWithID(s[1],this.app);else if("users"===s[0]&&6===i)r=Q.userWithID(s[1],this.app);else if("things"===s[0]&&6===i)r=V.thingWithID(s[1],this.app);else if(4!==i)throw new d(void 0,this);const o=new ft(n,r,this.app).createObject();return o.setUUID(s[i-1]),o}_userWithLoginName(t){return Et(this,void 0,void 0,(function*(){return Q.findUserByUsernameWithoutLogin(t,this.app)}))}getAccessToken(){return this.app.getAccessToken()}_getToken(){return this.app.getAccessToken()}groupWithID(t){if(null===t||""===t)throw"groupID should not null or empty";return x.groupWithID(t,this.app)}registerGroupWithOwnerAndID(t,e,s,i){return Et(this,void 0,void 0,(function*(){return yield x.registerGroupWithIDAndOwner(t,e,s,i,this.app)}))}groupWithURI(t){const e=t.substr("kiicloud://".length).split("/");if(2!==e.length||"groups"!==e[0])throw new d(void 0,this);return x.groupWithID(e[1],this.app)}findUserByEmail(t){return Et(this,void 0,void 0,(function*(){return Q.findUserByEmailWithoutLogin(t,this.app)}))}findUserByPhone(t){return Et(this,void 0,void 0,(function*(){return Q.findUserByPhoneWithoutLogin(t,this.app)}))}findUserByUsername(t){return Et(this,void 0,void 0,(function*(){return Q.findUserByUsernameWithoutLogin(t,this.app)}))}registerThing(t){return Et(this,void 0,void 0,(function*(){return V.register(t,this.app)}))}registerOwnerWithThingID(t,e){return Et(this,void 0,void 0,(function*(){return V.registerOwnerWithThingID(t,e,this.app)}))}registerOwnerWithThingIDAndPassword(t,e,s){return Et(this,void 0,void 0,(function*(){return V.registerOwnerWithThingIDAndPassword(t,e,s,this.app)}))}registerOwnerWithVendorThingID(t,e){return V.registerOwnerWithVendorThingID(t,e,this.app)}registerOwnerWithVendorThingIDAndPassword(t,e,s){return V.registerOwnerWithVendorThingIDAndPassword(t,e,s,this.app)}thingWithID(t){return V.thingWithID(t,this.app)}loadThingWithVendorThingID(t){return Et(this,void 0,void 0,(function*(){return V.loadWithVendorThingID(t,this.app)}))}loadThingWithThingID(t){const e={_thingID:t,_accessToken:this.app.getAccessToken()};return new V(e,this.app).refresh()}topicWithName(t){return new L("",t,this.app)}listTopics(t){return Et(this,void 0,void 0,(function*(){return this.app.listTopics(t)}))}}class Pt{constructor(t,e){this.app=e,this.thingId=t.thingId,t.vendorThingID&&(this.vendorThingID=t.vendorThingID)}bucketWithName(t){return new ft(t,null,this.app)}encryptedBucketWithName(t){return new wt(t,null,this.app)}objectWithURI(t){return this._objectWithURI(t)}topicWithName(t){if("string"!=typeof t||""===t)throw new u("topicName should not null or empty",this);return new L("",t,this.app)}listTopics(t){return e=this,s=arguments,n=function*(){return t||2!==arguments.length||"string"!=typeof arguments[1]||(t=arguments[1]),Ut.listTopics(t,this.app)},new((i=void 0)||(i=Promise))((function(t,r){function o(t){try{h(n.next(t))}catch(t){r(t)}}function a(t){try{h(n.throw(t))}catch(t){r(t)}}function h(e){var s;e.done?t(e.value):(s=e.value,s instanceof i?s:new i((function(t){t(s)}))).then(o,a)}h((n=n.apply(e,s||[])).next())}));var e,s,i,n}getAuthenticatedThing(){const t=V.thingWithID(this.thingId,this.app);return this.vendorThingID&&t.setVendorThingID(this.vendorThingID),t.setAccessToken(this.app.getAccessToken()),t}pushInstallation(){return new H(null,this.app)}_getToken(){return this.app.getAccessToken()}_objectWithURI(t){if(!t)throw new d(void 0,this);const e=0===t.indexOf("kiicloud://"),s=t.substr("kiicloud://".length).split("/"),i=s.length;if(i<4||!e)throw new d(void 0,this);const n=s[4===i?1:3];let r=null;if("groups"===s[0]&&6===i)r=x.groupWithID(s[1],this.app);else if("users"===s[0]&&6===i)r=Q.userWithID(s[1],this.app);else if("things"===s[0]&&6===i)r=V.thingWithID(s[1],this.app);else if(4!==i)throw new d(void 0,this);const o=new ft(n,r,this.app).createObject();return o.setUUID(s[i-1]),o}}var Rt=function(t,e,s,i){return new(s||(s=Promise))((function(n,r){function o(t){try{h(i.next(t))}catch(t){r(t)}}function a(t){try{h(i.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}h((i=i.apply(t,e||[])).next())}))};const St={US:"https://api.kii.com/api",JP:"https://api-jp.kii.com/api",SG:"https://api-sg.kii.com/api",EU:"https://api-eu.kii.com/api"};class Ut{constructor(t,e,s){this.logging=!0}static getBuildNumber(){return"1"}static getSDKVersion(){return"3.0.2"}static getBaseURL(){return At.globalApp.getBaseURL()}static getAppID(){return At.globalApp.getAppID()}static getAdditionalHeaders(){return this.additionalHeaders}static setAdditionalHeaders(t){this.additionalHeaders=t}static getAppKey(){return At.globalApp.getAppKey()}static isLogging(){return this._instance.logging}static setLogging(t){this._instance.logging=t}static setAccessTokenExpiration(t,e=At.globalApp){if(null==this._instance&&!e)throw k("Kii is not initialized",void 0);if(t<0)throw k("expiresIn should not negative number",void 0);e.setAccessTokenExpiration(t)}static getAccessTokenExpiration(t=At.globalApp){if(null==this._instance&&!t)throw k("Kii is not initialized",void 0);return t.getAccessTokenExpiration()}static initialize(t,e){return this.initializeWithSite(t,e,St.US)}static initializeWithSite(t,e,s){this._instance=new Ut(t,e,s);const i=new At(t,e,s);return At.globalApp=i,i}static logger(t){this._instance.logging&&console.log(t)}static bucketWithName(t){return At.globalApp.bucketWithName(t)}static encryptedBucketWithName(t){return At.globalApp.encryptedBucketWithName(t)}static groupWithName(t){return At.globalApp.groupWithName(t)}static groupWithNameAndMembers(t,e){return null}static logOut(){}static loggedIn(){return!1}static getCurrentUser(){return At.globalApp.getCurrentUser()}static setCurrentUser(t){At.globalApp.setCurrentUser(t,t.getAccessToken()||"")}static authenticateAsAppAdmin(t,e,s=At.globalApp){return Rt(this,arguments,void 0,(function*(){C(arguments[0])&&(t=arguments[1],e=arguments[2],s=arguments[3]||At.globalApp);const i=`/apps/${s.getAppID()}/oauth2/token`,n={grant_type:"client_credentials",client_id:t,client_secret:e},r=s.getAccessTokenExpiration();if(r>0){const t=(new Date).getTime();n.expiresAt=R(s.getAccessTokenExpiration(),t)}const o=s.newRequest("POST",i);o.isSendAccessToken(!1);const a=yield o.send(JSON.stringify(n));if(!y(a.status))throw g(0,a,void 0,null);a.body.id;const h=a.body.access_token,u=new At(s.getAppID(),s.getAppKey(),s.getBaseURL(),!0);return u.setAccessToken(h),r>0&&u.setAccessTokenExpiration(r),new _t(u)}))}static serverCodeEntry(t,e,s){if(!b(/^[a-zA-Z][_a-zA-Z0-9]*$/i,t))throw new u("entryName is invalid",void 0);if(null!=e&&("string"!=typeof(i=e)||""===i))throw new u("version is invalid",void 0);var i;return new Nt(t,e,s,At.globalApp)}static topicWithName(t,e=At.globalApp){if("string"!=typeof t||""===t)throw new u("topicName should not null or empty",void 0);return new L("",t,e)}static listTopics(t,e=At.globalApp){return e.listTopics(t)}static authenticateAsThing(t,e,s=At.globalApp){return Rt(this,void 0,void 0,(function*(){if(s instanceof At||(s=At.globalApp),!t||!e)throw Error("vendorThingID or password is invalid");const i={username:`VENDOR_THING_ID:${t}`,password:e},n=s.newRequest("POST","/oauth2/token");n.setContentType("application/vnd.kii.OauthTokenRequest+json"),n.isSendAccessToken(!1);const r=yield n.send(JSON.stringify(i));if(!y(r.status))throw g(0,r,void 0,null);const o=r.body.id,a=r.body.access_token;if(!o||!a)throw Error("invalid format response when authenticate thing ");const h=new At(s.getAppID(),s.getAppKey(),s.getBaseURL());return h.setAccessToken(a),new Pt({thingId:o,vendorThingID:t},h)}))}static authenticateAsThingWithToken(t,e,s=At.globalApp){return Rt(this,void 0,void 0,(function*(){if(s instanceof At||(s=At.globalApp),!t||!e)throw Error("thingID or token is invalid");const i=new At(s.getAppID(),s.getAppKey(),s.getBaseURL());return i.setAccessToken(e),Promise.resolve(new Pt({thingId:t},i))}))}}class kt{static getSDKClientInfo(){return 0==kt.clientInfo.length&&(kt.clientInfo=`sn=jss;sv=${Ut.getSDKVersion()}`),kt.clientInfo}}kt.clientInfo="";class Ct{constructor(t){this.app=t,this.username=void 0,this.password="",this.email=void 0,this.phoneNumber=void 0,this.country=void 0}static builderWithIdentifier(t,e,n=At.globalApp){if(null==t||""===t)throw new i("Invalid User Identifier set",void 0);const r=new Ct(n);if(!O(e))throw new s("Invalid Password pattern set",void 0);if(r.password=e,T(t))r.phoneNumber=t;else if(t=I(t),v(t))r.email=t;else{if(!E(t))throw new i("Invalid User Identifier set",void 0);r.username=t}return r}static builderWithEmailAddress(t,e,i=At.globalApp){const n=new Ct(i);if(!v(t))throw new a("Invalid username",void 0);if(n.setEmailAddress(t),!O(e))throw new s("Invalid username",void 0);return n.setPassword(e),n}static builderWithGlobalPhoneNumber(t,e,s=At.globalApp){const i=new Ct(s);return i.setPhoneNumber(t),i.setPassword(e),i}static builderWithLocalPhoneNumber(t,e,i,n=At.globalApp){const r=new Ct(n);if(!D(t))throw new o("Invalid local Phone Number",void 0);if(!N(e))throw new p(void 0,void 0);if(!O(i))throw new s("Invalid Password",void 0);return r.phoneNumber=t,r.country=e,r.password=i,r}static builderWithUsername(t,e,i=At.globalApp){const n=new Ct(i);if(!E(t))throw new s("Invalid username",void 0);if(!O(e))throw new s("Invalid Password",void 0);return n.username=t,n.password=e,n}setUsername(t){if(null==t)return this;const e=I(t);if(!E(e))throw new n(void 0,this);return this.username=e,this}setPassword(t){if(!O(t))throw new s("Invalid password",this);this.password=t}setEmailAddress(t){if(null==t)return this;const e=I(t);if(!v(e))throw new a("Invalid Email Address",this);return this.email=e,this}setPhoneNumber(t){if(!T(t))throw new o("Invalid Phone Number",this);this.phoneNumber=t}setGlobalPhoneNumber(t){if(null==t)return this;if(!T(t))throw new o("Invalid Global Phone Number",this);return this.phoneNumber=t,this.country=void 0,this}setLocalPhoneNumber(t,e){if(null==t)return this;if(!D(t))throw new o("Invalid Phone Number",this);if(this.phoneNumber=t,!N(e))throw new p(void 0,this);return this.country=e,this}setCountryCode(t){if(!N(t))throw new o("Invalid Country code",this);this.country=t}build(){const t=new Q(this.app);return this.username&&this.username.length>0&&t.setUsername(this.username),this.email&&t.setEmailAddress(this.email),this.country&&this.phoneNumber&&this.country.length>0?t.setLocalPhone(this.phoneNumber,this.country):this.phoneNumber&&t.setPhoneNumber(this.phoneNumber),t.setPassword(this.password),t}}class $t{constructor(t,e){this.latitude=t,this.longitute=e}getLatitude(){return this.latitude}getLongitude(){return this.longitute}toObject(){return{_type:"point",lat:this.latitude,lon:this.longitute}}static geoPoint(t,e){const s=(t,e,s)=>!isNaN(s)&&s>t&&s<e;if(!s(-90,90,t)||!s(-180,180,e))throw console.log("NOT IN RANGE"),new u("Specified latitide or longitude is invalid",void 0);return new $t(t,e)}static fromObject(t){const e=t.lat,s=t.lon;if(void 0!==e&&void 0!==s)return $t.geoPoint(e,s)}}class xt{constructor(){}getID(){return"ANONYMOUS_USER"}getACLEntityString(){return"UserID:ANONYMOUS_USER"}}class Wt{constructor(){}getID(){return"ANY_AUTHENTICATED_USER"}getACLEntityString(){return"UserID:ANY_AUTHENTICATED_USER"}}const jt={APP_NOT_FOUND:404,APP_DISABLED:403,UNAUTHORIZED:401,USER_NOT_FOUND:404,THING_NOT_FOUND:404,THING_DISABLED:401,THING_ALREADY_EXISTS:409,THING_TYPE_NOT_FOUND:404,FIRMWARE_VERSION_NOT_FOUND:404,WRONG_TOKEN:403,WRONG_REFRESH_TOKEN:403,INVALID_BUCKET:400,OPERATION_NOT_ALLOWED:409,OPERATION_NOT_SUPPORTED:403,AUTHENTICATION_FAILED:401,USER_DISABLED:401,INVALID_DATA_TYPE:400,INVALID_INPUT_DATA:400,INVALID_JSON:400,INVALID_JSON_SCHEMA:400,MISSING_DATA:400,RESOURCE_TEMPORARILY_UNAVAILABLE:503,WRONG_PASSWORD:401,OAUTH2_ERROR:400,THING_END_NODE_DOES_NOT_BELONG_TO_GATEWAY:404,THING_END_NODE_ALREADY_BELONGS_TO_GATEWAY:409,UNDEFINED_ERROR:500,OPERATION_NOT_IMPLEMENTED:501,LOCK_FAILED:503,QUERY_NOT_SUPPORTED:400,QUERY_TIMEOUT:503,TEMPORARY_UNAVAILABLE_ERROR:503,APP_ALREADY_EXISTS:409,BUCKET_ALREADY_EXISTS:409,BUCKET_NOT_FOUND:404,FILTER_NOT_FOUND:404,INVALID_ACCOUNT_STATUS:400,INVALID_OBJECT_ID:400,INVALID_VERIFICATION_CODE:403,OBJECT_NOT_FOUND:404,OBJECT_VERSION_IS_STALE:409,OBJECT_ALREADY_EXISTS:409,OBJECT_CONFLICT:409,PUBLICATION_NOT_FOUND:404,PUBLICATION_EXPIRED:410,USER_ALREADY_EXISTS:409,USER_ADDRESS_NOT_FOUND:404,VERIFICATION_CODE_NOT_FOUND:404,ACCOUNT_TYPE_NOT_SUPPORTED:400,OBJECT_BODY_NOT_FOUND:404,OBJECT_BODY_RANGE_NOT_SATISFIABLE:416,OBJECT_BODY_INTEGRITY_NOT_ASSURED:412,OBJECT_BODY_UPLOAD_NOT_FOUND:404,OBJECT_BODY_UPLOAD_ALREADY_EXISTS:409,BUCKET_TYPE_NOT_SUPPORTED:400,GROUP_NOT_FOUND:404,GROUP_ALREADY_EXISTS:409,INSTALLATION_NOT_FOUND:404,INSTALLATION_ALREADY_EXISTS:409,ACL_NOT_FOUND:404,ACL_ALREADY_EXISTS:409,VERSIONED_UPDATES_NOT_SUPPORTED:400,NO_ACCOUNT_PROVIDED:400,FACEBOOK_USER_ALREADY_LINKED:409,QQ_USER_ALREADY_LINKED:409,GOOGLE_USER_ALREADY_LINKED:409,USER_ALREADY_LINKED:409,USER_NOT_LINKED:409,UNIQUE_CONSTRAINT_VIOLATED:409,GCMKEY_ALREADY_EXISTS:409,GCMKEY_NOT_FOUND:404,APNSKEY_NOT_FOUND:404,JSON_WEB_KEY_NOT_FOUND:404,JPUSHKEY_NOT_FOUND:404,PUSH_SUBSCRIPTION_ALREADY_EXISTS:409,PUSH_SUBSCRIPTION_NOT_FOUND:404,TOPIC_ALREADY_EXISTS:409,TOPIC_NOT_FOUND:404,USER_LOCALE_NOT_FOUND:404,TEMPLATE_NOT_FOUND:404,USER_COUNTRY_NOT_FOUND:404,USER_DISPLAY_NAME_NOT_FOUND:404,SERVER_CODE_VERSION_NOT_FOUND:404,SERVER_CODE_HOOK_VERSION_NOT_FOUND:404,SCHEDULE_EXECUTION_NOT_FOUND:404,ENDPOINT_INVOCATION_ERROR:400,SERVER_CODE_VERIFICATION_ERROR:400,PAYLOAD_ID_NOT_FOUND:404,REPLACEMENT_SQL_QUERY_NOT_FOUND:404,APP_CONFIG_PARAMETER_NOT_FOUND:404,TRANSACTION_ID_NOT_FOUND:404,TRANSACTION_ID_ALREADY_EXISTS:409,CLIENT_CREDENTIALS_NOT_FOUND:404,ACCESS_CODE_NOT_FOUND:404,THING_OWNERSHIP_NOT_FOUND:404,THING_OWNERSHIP_ALREADY_EXISTS:409,INVALID_THING_OWNERSHIP_CODE:409,MQTT_ENDPOINT_NOT_FOUND:404,TASK_NOT_FOUND:404,TASK_NOT_RECURRENT:400,INVALID_STATUS:409,PHONE_NUMBER_VERIFICATION_CODE_EXPIRED:410,PIN_CODE_EXPIRED:410,ADDRESS_VERIFICATION_CODE_NOT_FOUND:404,MQTT_ENDPOINT_NOT_READY:503,INDEX_FAILED:500},Lt=new RegExp("(^[A-Z_]+): (.*)"),qt=new RegExp(" statusCode: (\\d{3}) error code: ([A-Z_]+) message: (.*)$"),Kt=new RegExp(" statusCode: (\\d{3}) error code: ([A-Z_]+) error message: (.*)$"),Mt=new RegExp(" statusCode: (\\d{3}) executedSteps: \\d+ error code: ([A-Z_]+) message: (.*) detailMessage: (.*)$"),Bt=new RegExp(" statusCode: (\\d{3}) executedSteps: null error code: ([A-Z_]+) message: (.*)$"),Vt=new RegExp("statusCode: (\\d{1,3})$");class Gt{constructor(t){this.error=t}}return Gt.parse=t=>{let e="";if(e="string"==(typeof t).toLowerCase()?t:t.message,0==e.indexOf("0 : http"))return{status:0,code:null,message:"Network Error"};if(0==e.indexOf("429 : http"))return{status:429,code:"TOO_MANY_REQUESTS",message:"Number of requests exceeds the limit."};if(0==e.indexOf("fail to execute server code. statusCode: 0"))return{status:0,code:null,message:"Network Error"};if(0==e.indexOf("invalid_grant: "))return{status:400,code:"invalid_grant",message:e.split(":",2)[1].substr(1)};if(0==e.indexOf("invalid_grant"))return{status:400,code:"invalid_grant",message:e};{let t=Vt.exec(e);if(t)return 429===Number(t[1])?{status:429,code:"TOO_MANY_REQUESTS",message:"Number of requests exceeds the limit."}:{status:0,code:null,message:"Network Error"};if(t=Lt.exec(e),t){const e=t[1],s=t[2];let i=jt[e];return i||(i=-2),{status:i,code:e,message:s}}for(let t of[qt,Kt,Mt,Bt]){const s=new RegExp(t).exec(e);if(s)return{status:Number(s[1]),code:s[2],message:s[3]}}return{status:-1,code:null,message:e}}},e})()}));